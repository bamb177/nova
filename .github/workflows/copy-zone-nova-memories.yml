name: Copy Memories -> public card (from another ref)

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: copy-memories-to-public-card
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      TARGET_REF: main
      SOURCE_REF: main  # <-- 여기를 src/assets/...가 있는 브랜치로 변경하세요

      SRC_PATH: src/assets/images/games/zone-nova/memories
      DST_PATH: public/images/games/zone-nova/card

    steps:
      # 1) 타겟(커밋/푸시할 브랜치) checkout
      - name: Checkout target ref
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_REF }}
          path: target
          fetch-depth: 0

      # 2) 소스(assets 존재 브랜치) checkout
      - name: Checkout source ref
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SOURCE_REF }}
          path: source
          fetch-depth: 0

      - name: Debug - show folders
        shell: bash
        run: |
          set -euo pipefail
          echo "Target root:"
          ls -la target | head
          echo "Source root:"
          ls -la source | head
          echo "Check source path:"
          ls -la "source/${SRC_PATH}" || true

      - name: Copy (mirror) source -> target
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -d "source/${SRC_PATH}" ]; then
            echo "[ERROR] Source folder not found: source/${SRC_PATH}"
            echo "Search candidates under source/:"
            find source -maxdepth 5 -type d -name "zone-nova" -o -name "memories" || true
            exit 1
          fi

          mkdir -p "target/${DST_PATH}"

          rsync -av --delete "source/${SRC_PATH}/" "target/${DST_PATH}/"

          echo "Copied file sample:"
          find "target/${DST_PATH}" -type f | head -n 30 || true

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail
          cd target

          if git status --porcelain | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add -A "${DST_PATH}"
            git commit -m "Copy memories images to public card"
            git push origin "${TARGET_REF}"
          else
            echo "[NO CHANGES] Nothing to commit."
          fi

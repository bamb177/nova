name: Copy Zone Nova Memories Images to Public Card

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: copy-zone-nova-memories-to-public-card
  cancel-in-progress: true

jobs:
  copy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - show repo root and key dirs
        shell: bash
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          echo "Top-level:"
          ls -la
          echo "Check src/assets/images/games/zone-nova:"
          ls -la src/assets/images/games/zone-nova || true
          echo "Check public/images/games/zone-nova:"
          ls -la public/images/games/zone-nova || true

      - name: Copy memories -> public card (with verification)
        shell: bash
        run: |
          set -euo pipefail

          SRC="src/assets/images/games/zone-nova/memories"
          DST="public/images/games/zone-nova/card"

          # 1) 소스 폴더 존재 강제 확인 (없으면 실패로 처리)
          if [ ! -d "$SRC" ]; then
            echo "[ERROR] Source folder not found: $SRC"
            echo "Search candidates under src/assets/images/games/zone-nova:"
            find src/assets/images/games/zone-nova -maxdepth 3 -type d -print || true
            exit 1
          fi

          mkdir -p "$DST"

          echo "SRC listing (top 50 files):"
          find "$SRC" -type f | head -n 50 || true

          # 2) 복사: rsync 미러링
          rsync -av --delete "$SRC"/ "$DST"/

          echo "DST listing (top 50 files):"
          find "$DST" -type f | head -n 50 || true

      - name: Debug - git status and ignored check
        shell: bash
        run: |
          set -euo pipefail
          echo "git status:"
          git status --porcelain || true

          echo "Ignored check (if nothing shows in status, this matters):"
          # 대상 경로가 .gitignore에 걸리면 add가 안 먹습니다.
          git check-ignore -v public/images/games/zone-nova/card || true
          git check-ignore -v public/images/games/zone-nova/card/** || true

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail

          if git status --porcelain | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            git add -A public/images/games/zone-nova/card
            git commit -m "Copy memories images to public card"
            git push
          else
            echo "[NO CHANGES] Nothing to commit."
          fi

name: Deploy to Cloud Run

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
  GAR_REPOSITORY: ${{ secrets.GAR_REPOSITORY }}
  SERVICE: ${{ secrets.CLOUD_RUN_SERVICE }}
  REGION: ${{ secrets.CLOUD_RUN_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
         gcloud auth configure-docker "${GAR_LOCATION}-docker.pkg.dev" --quiet

      - name: Build & Push Image
        run: |
          set -euo pipefail
      
          # 혹시 들어갔을지 모르는 CR/LF 및 앞뒤 공백 제거
          sanitize() { printf '%s' "$1" | tr -d '\r\n' | xargs; }
      
          PROJECT_ID="$(sanitize "${PROJECT_ID}")"
          GAR_LOCATION="$(sanitize "${GAR_LOCATION}")"
          GAR_REPOSITORY="$(sanitize "${GAR_REPOSITORY}")"
          SERVICE="$(sanitize "${SERVICE}")"
      
          IMAGE="${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${GAR_REPOSITORY}/${SERVICE}:${GITHUB_SHA}"
      
          echo "Building image (masked components):"
          echo "  GAR_LOCATION=${#GAR_LOCATION} chars, PROJECT_ID=${#PROJECT_ID} chars, REPO=${#GAR_REPOSITORY} chars, SERVICE=${#SERVICE} chars"
      
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.IMAGE }}

      - name: Show URL
        run: echo "Deployed to ${{ steps.deploy.outputs.url }}"

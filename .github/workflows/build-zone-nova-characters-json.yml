name: Sync Zone Nova characters (RAW)

on:
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-zone-nova-characters-raw
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (your repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 원본 데이터를 가져오는 단계
      - name: Clone upstream repository
        run: |
          git clone --depth 1 https://github.com/boring877/gacha-wiki.git _upstream_gachawiki

      # 변환 없이(=주석/포맷 그대로) 원본 파일을 public/data로 복사
      - name: Sync RAW JS/TS (no transform, keep comments)
        env:
          ZONE_NOVA_SEARCH_ROOT: _upstream_gachawiki
        run: node scripts/sync_zone_nova_characters_raw.mjs

      # 변경 사항이 있으면 커밋/푸시
      # - remote(main)에 선행 커밋이 있으면 pull --rebase로 흡수 후 push
      - name: Commit & push if changed (with rebase)
        run: |
          set -e

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add public/data/zone-nova/characters
          git commit -m "sync(zone-nova): update characters (raw upstream)"

          # 최신 원격 반영 (non-fast-forward 방지)
          git fetch origin main

          # rebase 시도 (충돌 나면 실패하게 두는 게 안전)
          git pull --rebase origin main

          # push 재시도(네트워크/경합 대비)
          git push origin HEAD:main

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --accent:rgba(96,165,250,.9);
      --danger:rgba(248,113,113,.9);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial;
      background: radial-gradient(1200px 800px at 50% -10%, rgba(59,130,246,.25), transparent 60%),
                  radial-gradient(1000px 700px at 10% 10%, rgba(168,85,247,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit; text-decoration:none}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: rgba(5,10,20,.65);
      border-bottom:1px solid var(--line);
      padding:10px 14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px}
    .pill{
      border:1px solid var(--line);
      background: var(--panel);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .btn{
      border:1px solid var(--line);
      background: var(--panel2);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      color:var(--text);
      font-weight:700;
    }
    .btn:hover{border-color:rgba(255,255,255,.18)}
    .btn.primary{border-color:rgba(96,165,250,.45); background:rgba(96,165,250,.18)}
    .btn.danger{border-color:rgba(248,113,113,.45); background:rgba(248,113,113,.10)}
    .wrap{
      padding:14px;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr; }
    }
    .card{
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .title{
      font-size:14px;
      font-weight:800;
      margin:0 0 10px 0;
      color:rgba(255,255,255,.9);
    }
    .sub{
      font-size:12px; color:var(--muted); margin-top:6px;
    }
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    select,input,textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .resultBox{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:12px;
      margin-top:12px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      color:rgba(255,255,255,.88);
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* grid */
    .gridTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .filters{
      display:grid; grid-template-columns: 160px 160px 160px 160px;
      gap:10px;
    }
    @media (max-width: 980px){
      .filters{grid-template-columns: 1fr 1fr;}
    }
    .gridActions{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0}
    .count{font-size:12px; color:var(--muted)}
    .gridWrap{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(0,0,0,.18);
      padding:12px;
      height: calc(100vh - 170px);
      overflow:auto;
    }
    @media (max-width: 980px){
      .gridWrap{height: auto; max-height: 70vh;}
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(190px, 1fr));
      gap:12px;
    }
    @media (max-width: 1200px){ .grid{grid-template-columns: repeat(3, minmax(170px, 1fr));} }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, minmax(160px, 1fr));} }
    @media (max-width: 540px){ .grid{grid-template-columns: 1fr;} }

    .charCard{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
      position:relative;
    }
    .thumb{
      width:100%;
      aspect-ratio: 4 / 3;
      background: rgba(0,0,0,.25);
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .thumb img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .noimg{
      font-weight:900;
      color: rgba(255,255,255,.35);
      letter-spacing:.4px;
    }
    .chk{
      position:absolute; top:10px; left:10px;
      width:18px; height:18px;
      accent-color: rgba(96,165,250,.95);
      z-index:3;
    }
    .meta{
      padding:10px 10px 12px 10px;
      background: rgba(0,0,0,.22);
      border-top:1px solid rgba(255,255,255,.08);
    }
    .name{
      font-weight:900;
      font-size:13px;
      line-height:1.2;
      margin-bottom:8px;
      color:rgba(255,255,255,.92);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .badges{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding:5px 8px;
      border-radius: 999px;
      font-size:12px;
      color: rgba(255,255,255,.88);
    }
    .badge .ico{
      width:16px; height:16px;
      object-fit:contain;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,.45));
    }
    .badge.rarity{
      font-weight:900;
      background: rgba(96,165,250,.12);
      border-color: rgba(96,165,250,.30);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div style="font-size:18px">{{ title }}</div>
      <div class="pill">캐시 {{ cache_count }} · 보스 {{ boss_count }} · 갱신 {{ last_refresh }}</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center">
      <a class="btn" href="/refresh">새로고침</a>
      <a class="btn" href="/meta">메타</a>
      <a class="btn" href="/zones/zone-nova/characters">캐릭터 JSON</a>
      <a class="btn" href="/zones/zone-nova/bosses">보스 JSON</a>
    </div>
  </div>

  <div class="wrap">
    <!-- left -->
    <div class="card">
      <div class="title">추천 옵션</div>
      {% if error %}
        <div class="sub" style="color:var(--danger); font-weight:800">데이터 로드 오류: {{ error }}</div>
      {% endif %}

      <label>모드</label>
      <select id="mode">
        <option value="pve">일반(PvE)</option>
        <option value="boss">보스</option>
        <option value="pvp">PVP</option>
      </select>

      <div class="sub" style="margin:10px 0 6px 0; font-weight:800">보스 선택 시 약점/속성 자동 반영</div>

      <label>보스 선택</label>
      <select id="bossSelect">
        <option value="">(선택 안 함)</option>
      </select>

      <div class="row" style="margin-top:10px">
        <div>
          <label>보스 약점 속성</label>
          <select id="bossWeakness">
            <option value="">(없음)</option>
            <option>Fire</option><option>Wind</option><option>Ice</option><option>Holy</option><option>Chaos</option>
          </select>
        </div>
        <div>
          <label>상대(적) 속성</label>
          <select id="enemyElement">
            <option value="">(없음)</option>
            <option>Fire</option><option>Wind</option><option>Ice</option><option>Holy</option><option>Chaos</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="runBtn">추천 실행</button>
        <button class="btn danger" id="clearBtn">초기화</button>
      </div>

      <div class="resultBox">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
          <div class="title" style="margin:0">결과</div>
          <button class="btn" id="copyBtn">JSON 복사</button>
        </div>
        <div class="mono" id="resultText">(아직 없음)</div>
      </div>

      <div class="sub" style="margin-top:10px">
        선택된 캐릭터는 오른쪽 카드에서 체크 → 추천 실행을 누르세요.
      </div>
    </div>

    <!-- right -->
    <div class="card">
      <div class="gridTop">
        <div class="title" style="margin:0">보유 캐릭터 선택(이미지 체크)</div>
        <div class="pill" id="selectedCount">선택 0</div>
      </div>

      <div class="filters">
        <div>
          <label>속성</label>
          <select id="fElement">
            <option value="">전체</option>
            <option>Fire</option><option>Wind</option><option>Ice</option><option>Holy</option><option>Chaos</option>
          </select>
        </div>
        <div>
          <label>직업</label>
          <select id="fRole">
            <option value="">전체</option>
            <!-- 7개든 그 이상이든, 데이터에 있는 role 기준으로 필터 추가됨 -->
          </select>
        </div>
        <div>
          <label>등급</label>
          <select id="fRarity">
            <option value="">전체</option>
            <option>SSR</option><option>SR</option><option>R</option>
          </select>
        </div>
        <div>
          <label>정렬</label>
          <select id="fSort">
            <option value="name">이름</option>
            <option value="rarity">등급</option>
            <option value="element">속성</option>
            <option value="role">직업</option>
          </select>
        </div>
      </div>

      <div class="gridActions">
        <button class="btn" id="selAllBtn">전체 선택</button>
        <button class="btn" id="selNoneBtn">전체 해제</button>
        <button class="btn" id="selVisibleBtn">보이는 것만 선택</button>
        <button class="btn" id="unselVisibleBtn">보이는 것만 해제</button>
      </div>

      <div class="gridWrap">
        <div class="grid" id="grid"></div>
      </div>
    </div>
  </div>

  <script>
    const CHARS = {{ chars_json | safe }};
    const BOSSES = {{ bosses_json | safe }};

    const $ = (id) => document.getElementById(id);

    const state = {
      selected: new Set(),
      filteredIds: [],
    };

    function uniqueRoles(chars){
      const s = new Set();
      for (const c of chars){
        if (c.role && c.role !== "-") s.add(String(c.role).toLowerCase());
      }
      return Array.from(s).sort();
    }

    function renderBosses(){
      const sel = $("bossSelect");
      for (const b of BOSSES){
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.name;
        opt.dataset.weakness = b.weakness || "";
        opt.dataset.enemy = b.enemy_element || "";
        sel.appendChild(opt);
      }
      sel.addEventListener("change", () => {
        const opt = sel.options[sel.selectedIndex];
        const w = opt?.dataset?.weakness || "";
        const e = opt?.dataset?.enemy || "";
        if (w) $("bossWeakness").value = w;
        if (e) $("enemyElement").value = e;
      });
    }

    function renderRoleFilter(){
      const sel = $("fRole");
      const roles = uniqueRoles(CHARS);
      // 기존 옵션(전체) 유지하고 나머지 재생성
      while (sel.options.length > 1) sel.remove(1);
      for (const r of roles){
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r; // 직업명은 영문 유지(요청대로 캐릭터 정보는 영어 유지)
        sel.appendChild(opt);
      }
    }

    function cmpSort(a, b, key){
      const av = (a[key] ?? "").toString().toLowerCase();
      const bv = (b[key] ?? "").toString().toLowerCase();
      if (av < bv) return -1;
      if (av > bv) return 1;
      return 0;
    }

    function applyFilter(){
      const fe = $("fElement").value;
      const fr = $("fRole").value;
      const frar = $("fRarity").value;
      const sortKey = $("fSort").value;

      let list = CHARS.slice();

      if (fe) list = list.filter(c => c.element === fe);
      if (fr) list = list.filter(c => String(c.role || "").toLowerCase() === fr);
      if (frar) list = list.filter(c => c.rarity === frar);

      list.sort((a,b) => cmpSort(a,b,sortKey));

      state.filteredIds = list.map(x => x.id);
      renderGrid(list);
      updateSelectedCount();
    }

    function cardEl(c){
      const div = document.createElement("div");
      div.className = "charCard";
      div.dataset.id = c.id;

      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.className = "chk";
      chk.checked = state.selected.has(c.id);
      chk.addEventListener("change", (e) => {
        if (e.target.checked) state.selected.add(c.id);
        else state.selected.delete(c.id);
        updateSelectedCount();
      });

      const thumb = document.createElement("div");
      thumb.className = "thumb";

      if (c.image){
        const img = document.createElement("img");
        img.loading = "lazy";
        img.src = c.image;
        img.alt = c.name;
        thumb.appendChild(img);
      } else {
        const no = document.createElement("div");
        no.className = "noimg";
        no.textContent = "NO IMAGE";
        thumb.appendChild(no);
      }

      const meta = document.createElement("div");
      meta.className = "meta";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = c.name;

      const badges = document.createElement("div");
      badges.className = "badges";

      // element badge
      const b1 = document.createElement("div");
      b1.className = "badge";
      if (c.element_icon){
        const ico = document.createElement("img");
        ico.className = "ico";
        ico.src = c.element_icon;
        ico.alt = c.element;
        b1.appendChild(ico);
      }
      b1.appendChild(document.createTextNode(c.element || "-"));

      // role badge (직업 7개든 그 이상이든 아이콘 있으면 자동 표시)
      const b2 = document.createElement("div");
      b2.className = "badge";
      if (c.role_icon){
        const ico = document.createElement("img");
        ico.className = "ico";
        ico.src = c.role_icon;
        ico.alt = c.role;
        b2.appendChild(ico);
      }
      b2.appendChild(document.createTextNode(c.role || "-"));

      // rarity badge
      const b3 = document.createElement("div");
      b3.className = "badge rarity";
      b3.textContent = c.rarity || "-";

      badges.appendChild(b1);
      badges.appendChild(b2);
      badges.appendChild(b3);

      meta.appendChild(name);
      meta.appendChild(badges);

      div.appendChild(chk);
      div.appendChild(thumb);
      div.appendChild(meta);

      // 카드 클릭으로 토글(체크박스 외 영역)
      div.addEventListener("click", (e) => {
        if (e.target === chk) return;
        if (e.target?.classList?.contains("ico")) return;
        chk.checked = !chk.checked;
        chk.dispatchEvent(new Event("change"));
      });

      return div;
    }

    function renderGrid(list){
      const g = $("grid");
      g.innerHTML = "";
      for (const c of list){
        g.appendChild(cardEl(c));
      }
    }

    function updateSelectedCount(){
      $("selectedCount").textContent = "선택 " + state.selected.size;
    }

    function setAll(checked){
      for (const id of (state.filteredIds.length ? state.filteredIds : CHARS.map(c=>c.id))){
        if (checked) state.selected.add(id);
        else state.selected.delete(id);
      }
      applyFilter();
      updateSelectedCount();
    }

    function setVisible(checked){
      for (const id of state.filteredIds){
        if (checked) state.selected.add(id);
        else state.selected.delete(id);
      }
      applyFilter();
      updateSelectedCount();
    }

    function runRecommend(){
      const payload = {
        mode: $("mode").value,
        owned: Array.from(state.selected),
        boss_weakness: $("bossWeakness").value || null,
        enemy_element: $("enemyElement").value || null,
        required: [],
        banned: [],
      };

      fetch("/recommend/v3", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(j => {
        $("resultText").textContent = JSON.stringify(j, null, 2);
      })
      .catch(err => {
        $("resultText").textContent = "오류: " + (err?.message || err);
      });
    }

    function copyResult(){
      const txt = $("resultText").textContent || "";
      navigator.clipboard.writeText(txt).catch(()=>{});
    }

    // wire
    $("fElement").addEventListener("change", applyFilter);
    $("fRole").addEventListener("change", applyFilter);
    $("fRarity").addEventListener("change", applyFilter);
    $("fSort").addEventListener("change", applyFilter);

    $("selAllBtn").addEventListener("click", () => setAll(true));
    $("selNoneBtn").addEventListener("click", () => setAll(false));
    $("selVisibleBtn").addEventListener("click", () => setVisible(true));
    $("unselVisibleBtn").addEventListener("click", () => setVisible(false));

    $("runBtn").addEventListener("click", runRecommend);
    $("clearBtn").addEventListener("click", () => { state.selected.clear(); applyFilter(); $("resultText").textContent="(아직 없음)"; });
    $("copyBtn").addEventListener("click", copyResult);

    // init
    renderBosses();
    renderRoleFilter();
    applyFilter();
  </script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="title">
        <h1>{{ title }}</h1>
        <div class="meta">
          <span>캐릭터: {{ cache_count }}</span>
          <span>보스: {{ boss_count }}</span>
          <span>갱신: {{ last_refresh }}</span>
          {% if error %}
            <span class="error">ERROR: {{ error }}</span>
          {% endif %}
        </div>
      </div>
      <div class="actions">
        <a class="btn" href="/refresh">Refresh</a>
      </div>
    </header>

    <section class="panel">
      <div class="panel-head">
        <div class="panel-title">캐릭터 목록</div>
        <div class="panel-sub">체크박스로 보유(Owned) 캐릭터를 선택하세요.</div>
      </div>

      <div class="table-wrap">
        <table class="char-table" id="charTable">
          <thead>
            <tr>
              <th class="col-check">선택</th>
              <th class="col-char">캐릭터</th>
              <th class="col-elem">속성</th>
              <th class="col-faction">특성</th>
              <th class="col-class">클래스</th>
              <th class="col-role">역할</th>
              <th class="col-rarity">등급</th>
            </tr>
          </thead>
          <tbody id="charTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const CHARS = {{ chars_json|safe }};

    function valueSlug(v) {
      return (v || "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[’']/g, "")
        .replace(/[–—−]/g, "-")
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-]/g, "")
        .replace(/\-+/g, "-");
    }

    // ✅ 역할 표기: Disruptor(=debuffer 클래스)는 DPS로 표기
    function roleLabel(role, cls) {
      const c = (cls || "-").toString().toLowerCase();
      if (c === "debuffer") return "DPS";

      const r = (role || "-").toString().toLowerCase();
      if (r === "dps") return "DPS";
      if (r === "-" || r === "") return "-";
      return r.charAt(0).toUpperCase() + r.slice(1);
    }

    function classLabel(cls) {
      const c = (cls || "-").toString().toLowerCase();
      if (c === "debuffer") return "Disruptor";
      if (c === "-" || c === "") return "-";
      return c.charAt(0).toUpperCase() + c.slice(1);
    }

    function rarityClass(r) {
      const x = (r || "-").toString().toUpperCase();
      if (x === "SSR") return "rarity ssr"; // ✅ 노란 그라데이션(요청 3)
      if (x === "SR")  return "rarity sr";  // ✅ 주황 그라데이션(요청 3)
      if (x === "R")   return "rarity r";
      return "rarity none";
    }

    function badge(kind, text, iconUrl) {
      const t = (text || "-").toString().trim();
      const slug = valueSlug(t);
      const icon = iconUrl ? `<img class="badge-icon" src="${iconUrl}" alt="" />` : "";
      return `
        <span class="badge badge-${kind} badge-${kind}--${slug}">
          ${icon}<span class="badge-text">${t || "-"}</span>
        </span>
      `;
    }

    function render() {
      const tbody = document.getElementById("charTbody");
      tbody.innerHTML = "";

      for (const c of CHARS) {
        const img = c.image
          ? `<img class="avatar" src="${c.image}" alt="" />`
          : `<div class="avatar placeholder"></div>`;

        const name = c.name || c.id || "-";

        const elemText = c.element || "-";
        const elem = badge("elem", elemText, c.element_icon);

        const factionText = (c.faction || "-");
        const faction = badge("faction", factionText, null);  // ✅ 특성도 배지(요청 1)

        const clsText = classLabel(c.class);
        const cls = badge("class", clsText, c.class_icon);

        const roleText = roleLabel(c.role, c.class);
        const role = badge("role", roleText, null);           // ✅ 역할도 배지(요청 1)

        const rarity = `<span class="${rarityClass(c.rarity)}">${(c.rarity || "-").toString().toUpperCase()}</span>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-check"><input type="checkbox" class="chk-owned" data-id="${c.id}" /></td>
          <td class="col-char">
            <div class="char-cell">
              ${img}
              <div class="char-name">${name}</div>
            </div>
          </td>
          <td class="col-elem">${elem}</td>
          <td class="col-faction">${faction}</td>
          <td class="col-class">${cls}</td>
          <td class="col-role">${role}</td>
          <td class="col-rarity">${rarity}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    render();
  </script>
</body>
</html>

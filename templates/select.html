<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>{{ title }}</title>
  <style>
    body{margin:0;font-family:system-ui,"Noto Sans KR","Malgun Gothic",sans-serif;background:#0b1020;color:#eaf0ff;}
    a{color:#86b6ff;text-decoration:none} a:hover{text-decoration:underline}
    .top{position:sticky;top:0;background:rgba(11,16,32,.92);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.12);}
    .topIn{max-width:1280px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .badge{font-size:12px;color:rgba(255,255,255,.75);border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);padding:6px 10px;border-radius:999px;}
    .wrap{max-width:1280px;margin:0 auto;padding:14px 16px 24px;}
    .grid{display:grid;grid-template-columns:380px 1fr;gap:12px;align-items:start;}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
    .card{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);border-radius:14px;overflow:hidden;}
    .hd{padding:12px 12px;border-bottom:1px solid rgba(255,255,255,.10);font-weight:800;font-size:13px;display:flex;justify-content:space-between;gap:10px;}
    .bd{padding:12px;}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:end;}
    label{font-size:12px;color:rgba(255,255,255,.72);display:block;margin-bottom:6px;}
    select,input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:#eaf0ff;outline:none;}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.08);color:#eaf0ff;font-weight:800;cursor:pointer;}
    .btn:hover{background:rgba(255,255,255,.12);}
    .btnP{border-color:rgba(134,182,255,.45);background:rgba(134,182,255,.18);}
    .btnD{border-color:rgba(255,93,108,.55);background:rgba(255,93,108,.12);}
    .small{font-size:12px;color:rgba(255,255,255,.70);line-height:1.5;}
    .warn{color:#ffb4be;}
    .gridWrap{margin-top:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);border-radius:14px;padding:10px;min-height:420px;max-height:calc(100vh - 260px);overflow:auto;}
    .charGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;}
    @media(max-width:1100px){.charGrid{grid-template-columns:repeat(5,1fr);}}
    @media(max-width:980px){.charGrid{grid-template-columns:repeat(4,1fr);} .gridWrap{max-height:none;}}
    @media(max-width:680px){.charGrid{grid-template-columns:repeat(3,1fr);}}
    @media(max-width:520px){.charGrid{grid-template-columns:repeat(2,1fr);}}
    .item{border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:hidden;background:rgba(0,0,0,.16);position:relative;cursor:pointer;}
    .item.sel{border-color:rgba(134,182,255,.6);box-shadow:0 0 0 3px rgba(134,182,255,.12);}
    .thumb{width:100%;aspect-ratio:1/1;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.35);font-weight:900;}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .ck{position:absolute;top:8px;left:8px;width:22px;height:22px;border-radius:7px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;}
    .ck input{width:16px;height:16px;margin:0;accent-color:#86b6ff;}
    .badges{position:absolute;bottom:8px;left:8px;right:8px;display:flex;gap:6px;flex-wrap:wrap;}
    .tag{font-size:11px;padding:3px 7px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.40);color:rgba(255,255,255,.86);}
    .name{padding:10px 10px;font-weight:900;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-top:1px solid rgba(255,255,255,.06);}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,Consolas,monospace;font-size:12px;}
    hr{border:none;border-top:1px solid rgba(255,255,255,.10);margin:10px 0;}
    .tabs{display:flex;gap:8px;align-items:center;}
    .tab{font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);cursor:pointer;color:rgba(255,255,255,.85);}
    .tab.on{border-color:rgba(134,182,255,.55);background:rgba(134,182,255,.18);}
    .copyBtn{font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.08);cursor:pointer;color:rgba(255,255,255,.88);}
    .copyBtn:hover{background:rgba(255,255,255,.12);}
    .partyGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    @media(max-width:980px){.partyGrid{grid-template-columns:repeat(2,1fr);}}
    @media(max-width:520px){.partyGrid{grid-template-columns:1fr;}}
    .pCard{border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);border-radius:14px;overflow:hidden;}
    .pThumb{width:100%;aspect-ratio:16/10;background:rgba(255,255,255,.06);}
    .pThumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .pBody{padding:10px;}
    .pName{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .pMeta{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;}
    .pScore{margin-top:8px;font-weight:900;}
    .kv{margin-top:8px;font-size:12px;color:rgba(255,255,255,.78);line-height:1.55;}
    .kv b{color:#eaf0ff;}
  </style>
</head>
<body>
<div class="top">
  <div class="topIn">
    <div style="font-weight:900;">{{ title }}</div>
    <span class="badge">ìºì‹œ {{ cache_count }} Â· ë³´ìŠ¤ {{ boss_count }} Â· ê°±ì‹  {{ last_refresh }}</span>
    <a class="badge" href="/refresh">ìƒˆë¡œê³ ì¹¨</a>
    <a class="badge" href="/meta">ë©”íƒ€</a>
    <a class="badge" href="/zones/zone-nova/characters">ìºë¦­í„° JSON</a>
    <a class="badge" href="/zones/zone-nova/bosses">ë³´ìŠ¤ JSON</a>
  </div>
</div>

<div class="wrap">
  {% if error %}
  <div class="card" style="margin-bottom:12px;">
    <div class="hd"><span>ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜</span></div>
    <div class="bd"><div class="warn small">{{ error }}</div></div>
  </div>
  {% endif %}

  <div class="grid">
    <div class="card">
      <div class="hd"><span>ì¶”ì²œ ì˜µì…˜</span><span class="small">ë³´ìŠ¤ ì„ íƒ ì‹œ ì•½ì /ì†ì„± ìë™ ë°˜ì˜</span></div>
      <div class="bd">
        <div class="row">
          <div style="flex:1;min-width:140px;">
            <label>ëª¨ë“œ</label>
            <select id="mode">
              <option value="pve">ì¼ë°˜(PvE)</option>
              <option value="boss">ë³´ìŠ¤</option>
              <option value="pvp">PvP</option>
            </select>
          </div>

          <div style="flex:1;min-width:220px;">
            <label>ë³´ìŠ¤ ì„ íƒ</label>
            <select id="boss_pick">
              <option value="">(ì„ íƒ ì•ˆ í•¨)</option>
            </select>
          </div>

          <div style="flex:1;min-width:160px;">
            <label>ë³´ìŠ¤ ì•½ì  ì†ì„±</label>
            <select id="boss_weakness">
              <option value="">(ì—†ìŒ)</option><option>Fire</option><option>Ice</option><option>Wind</option><option>Holy</option><option>Chaos</option>
            </select>
          </div>

          <div style="flex:1;min-width:160px;">
            <label>ìƒëŒ€(ì ) ì†ì„±</label>
            <select id="enemy_element">
              <option value="">(ì—†ìŒ)</option><option>Fire</option><option>Ice</option><option>Wind</option><option>Holy</option><option>Chaos</option>
            </select>
          </div>
        </div>

        <div style="height:12px;"></div>
        <div class="row">
          <button class="btn" id="btnReq">ì„ íƒ â†’ í•„ìˆ˜</button>
          <button class="btn" id="btnBan">ì„ íƒ â†’ ì œì™¸</button>
        </div>

        <div style="height:12px;"></div>
        <div><label>í•„ìˆ˜ í¬í•¨ (ì‰¼í‘œ)</label><input id="required" placeholder="ì˜ˆ) nina, freya"/></div>
        <div style="height:10px;"></div>
        <div><label>ì œì™¸ (ì‰¼í‘œ)</label><input id="banned" placeholder="ì˜ˆ) apep"/></div>

        <div style="height:12px;"></div>
        <div class="row">
          <button class="btn btnP" id="btnRun">ì¶”ì²œ ì‹¤í–‰</button>
          <button class="btn btnD" id="btnClear">ì´ˆê¸°í™”</button>
        </div>

        <div style="height:12px;"></div>
        <div class="card" style="background:rgba(0,0,0,.18);">
          <div class="hd" style="border-bottom:1px solid rgba(255,255,255,.08);">
            <span>ê²°ê³¼</span>
            <div class="tabs">
              <span class="tab on" id="tabTable">í‘œ ë³´ê¸°</span>
              <span class="tab" id="tabJson">JSON ë³´ê¸°</span>
              <button class="copyBtn" id="btnCopyJson">JSON ë³µì‚¬</button>
              <span id="selCnt" class="small">ì„ íƒ 0</span>
            </div>
          </div>
          <div class="bd">
            <div id="outTable" class="small">(ì•„ì§ ì—†ìŒ)</div>
            <div id="outJson" style="display:none;"><pre id="jsonPre">(ì•„ì§ ì—†ìŒ)</pre></div>
          </div>
        </div>

        <div style="height:10px;" class="small">ìƒì„±í‘œ(adv): Fireâ†’Windâ†’Iceâ†’Holyâ†’Chaosâ†’Fire</div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><span>ë³´ìœ  ìºë¦­í„° ì„ íƒ(ì´ë¯¸ì§€ ì²´í¬)</span><span class="small" id="stat">ì„ íƒ 0</span></div>
      <div class="bd">
        <div class="row">
          <button class="btn" id="btnAllOn">ì „ì²´ ì„ íƒ</button>
          <button class="btn" id="btnAllOff">ì „ì²´ í•´ì œ</button>
          <button class="btn" id="btnVisOn">ë³´ì´ëŠ” ê²ƒë§Œ ì„ íƒ</button>
          <button class="btn" id="btnVisOff">ë³´ì´ëŠ” ê²ƒë§Œ í•´ì œ</button>
        </div>

        <div style="height:10px;"></div>
        <div class="row">
          <div style="flex:1;min-width:150px;">
            <label>ì´ë¦„ í•„í„°(ì˜ì–´)</label>
            <input id="q" placeholder="ì˜ˆ) nina"/>
          </div>
        </div>

        <div class="gridWrap">
          <div class="charGrid" id="grid"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="application/json" id="chars">{{ chars_json | safe }}</script>
<script type="application/json" id="bosses">{{ bosses_json | safe }}</script>
<script type="application/json" id="adv">{{ adv_json | safe }}</script>

<script>
const CHARS = JSON.parse(document.getElementById('chars').textContent || "[]");
const BOSSES = JSON.parse(document.getElementById('bosses').textContent || "[]");
const ADV = JSON.parse(document.getElementById('adv').textContent || "{}");

const E_ICON = { Fire:"ğŸ”¥", Ice:"â„ï¸", Wind:"ğŸŒªï¸", Holy:"âœ¨", Chaos:"â˜¯ï¸", "-":"â”" };
const R_ICON = { tank:"ğŸ›¡ï¸", healer:"ğŸ’š", dps:"âš”ï¸", buffer:"ğŸ“£", debuffer:"ğŸ§ª", "-":"â”" };

let lastJsonText = "";

function stat(){
  const n = document.querySelectorAll('.owned:checked').length;
  document.getElementById('stat').textContent = 'ì„ íƒ ' + n;
  document.getElementById('selCnt').textContent = 'ì„ íƒ ' + n;
  document.querySelectorAll('.item').forEach(el=>{
    const cb=el.querySelector('input.owned');
    if(cb && cb.checked) el.classList.add('sel'); else el.classList.remove('sel');
  });
}

function csv(v){ v=(v||'').trim(); if(!v) return []; return v.split(',').map(x=>x.trim()).filter(Boolean); }
function uniq(arr){ const s=new Set(); const o=[]; for(const x of arr){ if(x && !s.has(x)){ s.add(x); o.push(x);} } return o; }
function checked(){ return Array.from(document.querySelectorAll('.owned:checked')).map(x=>x.value); }
function addCheckedTo(id){
  const ids = checked();
  if(!ids.length) return;
  const cur = csv(document.getElementById(id).value);
  document.getElementById(id).value = uniq(cur.concat(ids)).join(', ');
}

function makeCard(c){
  const el=document.createElement('div');
  el.className='item';
  el.dataset.name=(c.name||'').toLowerCase();

  const thumb=document.createElement('div');
  thumb.className='thumb';

  if(c.image){
    const img=document.createElement('img');
    img.src=c.image;
    img.onerror=()=>{ thumb.textContent='NO IMAGE'; img.remove(); };
    thumb.appendChild(img);
  } else {
    thumb.textContent='NO IMAGE';
  }

  const ck=document.createElement('div');
  ck.className='ck';
  const cb=document.createElement('input');
  cb.type='checkbox';
  cb.className='owned';
  cb.value=c.id;
  ck.appendChild(cb);

  const badges=document.createElement('div');
  badges.className='badges';
  const elem = (c.element || "-");
  const role = String(c.role || "-").toLowerCase();
  const rar = (c.rarity || "-");
  badges.innerHTML =
    '<span class="tag">' + ((E_ICON[elem]||"â”") + ' ' + elem) + '</span>' +
    '<span class="tag">' + ((R_ICON[role]||"â”") + ' ' + role) + '</span>' +
    '<span class="tag">ğŸ·ï¸ ' + rar + '</span>';

  const nm=document.createElement('div');
  nm.className='name';
  nm.textContent=c.name || c.id;

  el.appendChild(thumb);
  el.appendChild(ck);
  el.appendChild(badges);
  el.appendChild(nm);

  el.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.tagName==='INPUT') return;
    cb.checked = !cb.checked;
    stat();
  });
  cb.addEventListener('change', stat);

  return el;
}

function render(list){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  list.forEach(c=>grid.appendChild(makeCard(c)));
  stat();
}

function applyFilter(){
  const q=(document.getElementById('q').value||'').trim().toLowerCase();
  document.querySelectorAll('.item').forEach(el=>{
    if(!q) { el.style.display=''; return; }
    el.style.display = el.dataset.name.includes(q) ? '' : 'none';
  });
}

function fillBossSelect(){
  const sel = document.getElementById('boss_pick');
  for(const b of BOSSES){
    const opt = document.createElement('option');
    opt.value = b.id;
    opt.textContent = b.name || b.id;
    sel.appendChild(opt);
  }
}

function onBossPick(){
  const bid = document.getElementById('boss_pick').value;
  const b = BOSSES.find(x => x.id === bid);
  if(!b) return;

  if(b.weakness) document.getElementById('boss_weakness').value = b.weakness;
  if(b.enemy_element) document.getElementById('enemy_element').value = b.enemy_element;
  document.getElementById('mode').value = 'boss';
}

function setTab(which){
  const tabT = document.getElementById('tabTable');
  const tabJ = document.getElementById('tabJson');
  const outT = document.getElementById('outTable');
  const outJ = document.getElementById('outJson');
  if(which === 'json'){
    tabJ.classList.add('on'); tabT.classList.remove('on');
    outJ.style.display = ''; outT.style.display = 'none';
  } else {
    tabT.classList.add('on'); tabJ.classList.remove('on');
    outT.style.display = ''; outJ.style.display = 'none';
  }
}

function safe(v){
  return String(v ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

function renderResultTable(json){
  const box = document.getElementById('outTable');

  if(!json || !json.ok || !json.best_party){
    const issues = (json && json.issues) ? json.issues : ["ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."];
    box.innerHTML = '<div class="warn">- ' + issues.map(safe).join('<br>- ') + '</div>';
    return;
  }

  const bp = json.best_party;
  const members = bp.members || [];
  const analysis = bp.analysis || [];

  const header =
    '<div class="small">íŒ€ ì´ì : <b>' + safe(bp.team_total) + '</b> Â· êµ¬ì„±: ' + safe(bp.party_size) + 'ì¸</div>' +
    (analysis.length ? ('<div class="small" style="margin-top:6px;">' + analysis.map(safe).join(' Â· ') + '</div>') : '') +
    '<hr/>';

  let grid = '<div class="partyGrid">';
  for(const m of members){
    const bd = m.breakdown || {};
    const role = String(m.role || "-").toLowerCase();
    const elem = m.element || "-";
    const rar = m.rarity || "-";

    const img = m.image ? ('<img src="' + safe(m.image) + '" alt=""/>') : '';
    const thumb = '<div class="pThumb">' + img + '</div>';

    const meta =
      '<div class="pMeta">' +
        '<span class="tag">' + safe((E_ICON[elem]||"â”") + " " + elem) + '</span>' +
        '<span class="tag">' + safe((R_ICON[role]||"â”") + " " + role) + '</span>' +
        '<span class="tag">ğŸ·ï¸ ' + safe(rar) + '</span>' +
      '</div>';

    const kv =
      '<div class="kv">' +
        '<div><b>í¬ê·€ë„</b>: ' + safe(bd.rarity_pts) + '</div>' +
        '<div><b>ë³´ìŠ¤ ì•½ì </b>: ' + safe(bd.boss_bonus) + '</div>' +
        '<div><b>ìƒì„± ìœ ë¦¬</b>: ' + safe(bd.adv_bonus) + '</div>' +
        '<div><b>ìƒì„± ë¶ˆë¦¬</b>: ' + safe(bd.dis_penalty) + '</div>' +
        '<div><b>ì—­í•  ë³´ë„ˆìŠ¤</b>: ' + safe(bd.role_bonus) + '</div>' +
      '</div>';

    grid +=
      '<div class="pCard">' +
        thumb +
        '<div class="pBody">' +
          '<div class="pName">' + safe(m.name) + '</div>' +
          meta +
          '<div class="pScore">ì´ì : ' + safe(m.score) + '</div>' +
          kv +
        '</div>' +
      '</div>';
  }
  grid += '</div>';

  box.innerHTML = header + grid;
}

async function run(){
  const payload={
    mode: document.getElementById('mode').value,
    owned: checked(),
    required: csv(document.getElementById('required').value),
    banned: csv(document.getElementById('banned').value),
    boss_weakness: document.getElementById('boss_weakness').value || null,
    enemy_element: document.getElementById('enemy_element').value || null
  };

  if(payload.owned.length < 4){
    document.getElementById('outTable').innerHTML =
      '<div class="warn">ë³´ìœ  ìºë¦­í„°ëŠ” ìµœì†Œ 4ëª… ì²´í¬í•´ì•¼ í•©ë‹ˆë‹¤.</div>';
    document.getElementById('jsonPre').textContent = '';
    lastJsonText = '';
    setTab('table');
    return;
  }

  document.getElementById('outTable').innerHTML = '<div class="small">ê³„ì‚° ì¤‘...</div>';
  document.getElementById('jsonPre').textContent = '';
  lastJsonText = '';
  setTab('table');

  const res = await fetch('/recommend/v3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const json = await res.json();

  lastJsonText = JSON.stringify(json, null, 2);
  document.getElementById('jsonPre').textContent = lastJsonText;

  renderResultTable(json);
}

function clearAll(){
  document.querySelectorAll('.owned').forEach(x=>x.checked=false);
  ['required','banned','boss_weakness','enemy_element','q','boss_pick'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    if(el.tagName==='SELECT') el.value=''; else el.value='';
  });
  document.getElementById('outTable').textContent='(ì•„ì§ ì—†ìŒ)';
  document.getElementById('jsonPre').textContent='(ì•„ì§ ì—†ìŒ)';
  lastJsonText = '';
  stat(); applyFilter();
  setTab('table');
}

async function copyJson(){
  if(!lastJsonText) return;
  try {
    await navigator.clipboard.writeText(lastJsonText);
  } catch(e) {
    const pre = document.getElementById('jsonPre');
    const range = document.createRange();
    range.selectNodeContents(pre);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    document.execCommand('copy');
    sel.removeAllRanges();
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  render(CHARS);
  fillBossSelect();

  document.getElementById('q').addEventListener('input', applyFilter);
  document.getElementById('boss_pick').addEventListener('change', onBossPick);

  document.getElementById('btnAllOn').onclick=()=>{ document.querySelectorAll('.owned').forEach(x=>x.checked=true); stat(); };
  document.getElementById('btnAllOff').onclick=()=>{ document.querySelectorAll('.owned').forEach(x=>x.checked=false); stat(); };

  const visibleItems=()=>Array.from(document.querySelectorAll('.item')).filter(el=>el.style.display!=='none');
  document.getElementById('btnVisOn').onclick=()=>{ visibleItems().forEach(el=>el.querySelector('.owned').checked=true); stat(); };
  document.getElementById('btnVisOff').onclick=()=>{ visibleItems().forEach(el=>el.querySelector('.owned').checked=false); stat(); };

  document.getElementById('btnReq').onclick=()=>addCheckedTo('required');
  document.getElementById('btnBan').onclick=()=>addCheckedTo('banned');

  document.getElementById('btnRun').onclick=run;
  document.getElementById('btnClear').onclick=clearAll;

  document.getElementById('tabTable').onclick=()=>setTab('table');
  document.getElementById('tabJson').onclick=()=>setTab('json');
  document.getElementById('btnCopyJson').onclick=copyJson;

  setTab('table');
});
</script>
</body>
</html>

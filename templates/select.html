<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>

  <!-- 기존 공용 CSS -->
  <link rel="stylesheet" href="/css/style.css" />
  <!-- 페이지 전용 CSS(분리본) -->
  <link rel="stylesheet" href="/css/select.css" />
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>{{ title }}</h1>
        <div class="meta">
          캐릭터 {{ cache_count }}명 · 보스 {{ boss_count }}개 · 갱신 {{ last_refresh }}
        </div>
      </div>
      <div class="actions">
        <a class="btn" href="/refresh">새로고침</a>
        <div class="badge">데이터: <span id="sourceHint">-</span></div>
      </div>
    </div>

    {% if error %}
      <div class="error">로딩 오류: {{ error }}</div>
    {% endif %}

    <div class="panel">
      <div class="filters">
        <input id="q" class="input" type="text" placeholder="검색 (이름/ID/특성/속성)" autocomplete="off" />
        <select id="rarityFilter" class="select">
          <option value="">등급(전체)</option>
          <option value="SSR">SSR</option>
          <option value="SR">SR</option>
          <option value="R">R</option>
          <option value="-">-</option>
        </select>
        <select id="elemFilter" class="select">
          <option value="">속성(전체)</option>
        </select>
        <select id="factionFilter" class="select">
          <option value="">특성(전체)</option>
        </select>
        <select id="classFilter" class="select">
          <option value="">클래스(전체)</option>
        </select>
        <select id="roleFilter" class="select">
          <option value="">역할(전체)</option>
        </select>

        <button class="btn" id="btnAll" type="button">전체 선택</button>
        <button class="btn" id="btnNone" type="button">전체 해제</button>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th class="col-check">선택</th>
            <th>캐릭터</th>
            <th class="col-elem">속성</th>
            <th class="col-faction">특성</th>
            <th class="col-class">클래스</th>
            <th class="col-role">역할</th>
            <th class="col-rarity">등급</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ===== Modal ===== -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Character</div>
        <button class="modal-close" id="modalClose" type="button">×</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="modal-loading">Loading…</div>
      </div>
    </div>
  </div>

  <script>
    const CHARS_RAW = {{ chars_json|safe }};

    function escapeHtml(str) {
      return (str || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function dedupeById(list){
      const m = new Map();
      for (const c of (list || [])){
        if (!c) continue;
        const id = (c.id || "").toString().trim();
        if (!id) continue;
        if (!m.has(id)) m.set(id, c);
      }
      return Array.from(m.values());
    }

    const RARITY_ORDER = { "SSR": 3, "SR": 2, "R": 1, "-": 0 };

    const ELEM_LABEL = {
      "Fire": "Blaze",
      "Wind": "Storm",
      "Ice": "Frost",
      "Holy": "Holy",
      "Chaos": "Chaos",
      "Blaze": "Blaze",
      "Storm": "Storm",
      "Frost": "Frost"
    };

    function elemClass(label){
      const v = (label || "").toString();
      const x = ELEM_LABEL[v] || v || "-";
      const low = x.toLowerCase();
      if (low === "blaze") return "elem-blaze";
      if (low === "storm") return "elem-storm";
      if (low === "frost") return "elem-frost";
      if (low === "holy")  return "elem-holy";
      if (low === "chaos") return "elem-chaos";
      return "";
    }

    function classLabel(cls){
      const v = (cls || "-").toString().trim().toLowerCase();
      if (v === "debuffer") return "Disruptor";
      if (v === "guardian") return "Guardian";
      if (v === "healer") return "Healer";
      if (v === "buffer") return "Buffer";
      if (v === "mage") return "Mage";
      if (v === "rogue") return "Rogue";
      if (v === "warrior") return "Warrior";
      return (cls && cls !== "-") ? (cls.charAt(0).toUpperCase() + cls.slice(1)) : "-";
    }

    function roleLabel(role, cls){
      const c = (cls || "-").toString().trim().toLowerCase();
      if (c === "debuffer") return "DPS";

      const r = (role || "-").toString().trim().toLowerCase();
      if (r === "dps") return "DPS";
      if (r === "-" || !r) return "-";
      return r.charAt(0).toUpperCase() + r.slice(1);
    }

    function rarityPillClass(r){
      const v = (r || "-").toString().trim().toUpperCase();
      if (v === "SSR") return "pill-ssr";
      if (v === "SR") return "pill-sr";
      if (v === "R") return "pill-r";
      return "pill-none";
    }

    function normalizeFaction(f){
      return (f || "-").toString().trim() || "-";
    }

    function normalizeElem(e){
      const v = (e || "-").toString().trim();
      return ELEM_LABEL[v] || v || "-";
    }

    // ===== detail helpers =====
    function pick(obj, ...keys) {
      for (const k of keys) {
        const v = obj?.[k];
        if (v !== undefined && v !== null) return v;
      }
      return null;
    }

    function isEmpty(v) {
      if (v === null || v === undefined) return true;
      if (Array.isArray(v)) return v.length === 0;
      if (typeof v === "object") return Object.keys(v).length === 0;
      if (typeof v === "string") return v.trim() === "";
      return false;
    }

    function renderKV(obj) {
      if (!obj || typeof obj !== "object") return `<div class="detail-empty">데이터 없음</div>`;
      const rows = Object.entries(obj).map(([k, v]) => {
        const vv = (typeof v === "object") ? JSON.stringify(v) : String(v);
        return `<tr><td class="kv-k">${escapeHtml(k)}</td><td class="kv-v">${escapeHtml(vv)}</td></tr>`;
      }).join("");
      return `<table class="kv"><tbody>${rows}</tbody></table>`;
    }

    // 단일 스킬 객체 판별
    function looksLikeSkillObject(o){
      if (!o || typeof o !== "object" || Array.isArray(o)) return false;
      const keys = [
        "name","title","skillName",
        "description","desc","text",
        "cooldown","energyCost","cost","sp",
        "type","category","target"
      ];
      return keys.some(k => o[k] !== undefined && o[k] !== null);
    }

    function normalizeSkillEntry(x, fallbackTitle) {
      if (!x) return { title: fallbackTitle || "-", desc: "", extra: null };

      if (typeof x === "string") {
        return { title: fallbackTitle || "-", desc: x, extra: null };
      }

      if (typeof x === "object") {
        const title =
          (typeof x.name === "string" && x.name) ||
          (typeof x.title === "string" && x.title) ||
          (typeof x.skillName === "string" && x.skillName) ||
          fallbackTitle || "-";

        const desc =
          (typeof x.description === "string" && x.description) ||
          (typeof x.desc === "string" && x.desc) ||
          (typeof x.text === "string" && x.text) ||
          "";

        const extra = {};
        for (const [k, v] of Object.entries(x)) {
          if (["name","title","skillName","description","desc","text"].includes(k)) continue;
          if (v === null || v === undefined) continue;
          if (typeof v === "object") continue;
          extra[k] = v;
        }
        return { title, desc, extra: Object.keys(extra).length ? extra : null };
      }

      return { title: fallbackTitle || "-", desc: String(x), extra: null };
    }

    function renderOneSkillCard(s) {
      const desc = s.desc
        ? `<div class="card-desc">${escapeHtml(s.desc)}</div>`
        : `<div class="card-desc" style="opacity:.75;">(설명 없음)</div>`;
      const extra = s.extra ? renderKV(s.extra) : "";
      return `
        <div class="card">
          <div class="card-title"><span>${escapeHtml(String(s.title || "-"))}</span></div>
          ${desc}
          ${extra ? `<div style="margin-top:8px;">${extra}</div>` : ""}
        </div>
      `;
    }

    function renderSkillCards(skillsObjOrArr) {
      if (isEmpty(skillsObjOrArr)) return `<div class="detail-empty">스킬 데이터 없음</div>`;

      if (looksLikeSkillObject(skillsObjOrArr)) {
        const s = normalizeSkillEntry(skillsObjOrArr, "Skill");
        return `<div class="cards">${renderOneSkillCard(s)}</div>`;
      }

      if (Array.isArray(skillsObjOrArr)) {
        const cards = skillsObjOrArr
          .map((x, idx) => renderOneSkillCard(normalizeSkillEntry(x, `Skill ${idx + 1}`)))
          .join("");
        return `<div class="cards">${cards}</div>`;
      }

      if (typeof skillsObjOrArr === "object") {
        const cards = [];
        for (const [k, v] of Object.entries(skillsObjOrArr)) {
          if (isEmpty(v)) continue;

          if (looksLikeSkillObject(v)) {
            cards.push(renderOneSkillCard(normalizeSkillEntry(v, k)));
            continue;
          }

          if (Array.isArray(v)) {
            for (let i = 0; i < v.length; i++) {
              cards.push(renderOneSkillCard(normalizeSkillEntry(v[i], `${k} ${i + 1}`)));
            }
          }
        }

        if (cards.length === 0) {
          const s = normalizeSkillEntry(skillsObjOrArr, "Skill");
          return `<div class="cards">${renderOneSkillCard(s)}</div>`;
        }
        return `<div class="cards">${cards.join("")}</div>`;
      }

      const s = normalizeSkillEntry(skillsObjOrArr, "Skill");
      return `<div class="cards">${renderOneSkillCard(s)}</div>`;
    }

    // 5 섹션 고정 + (3) 색상 구분용 class 부여
    function renderSkills(detail) {
      const skills = pick(detail, "skills") || {};
      const teamSkill = pick(detail, "teamSkill", "team_skill", "team");

      const normalData = !isEmpty(skills?.normal) ? skills.normal : skills?.basic;

      const sections = [
        { key: "auto",     label: "Auto",      data: skills?.auto,     css: "group-auto" },
        { key: "ultimate", label: "Ultimate",  data: skills?.ultimate, css: "group-ultimate" },
        { key: "passive",  label: "Passive",   data: skills?.passive,  css: "group-passive" },
        { key: "normal",   label: "Normal",    data: normalData,       css: "group-normal" },
        { key: "team",     label: "Team Skill",data: teamSkill,        css: "group-team" },
      ];

      return sections.map(s => `
        <div class="group ${s.css}">
          <div class="group-title">${escapeHtml(s.label)}</div>
          ${isEmpty(s.data) ? `<div class="detail-empty">${escapeHtml(s.label)} 데이터 없음</div>` : renderSkillCards(s.data)}
        </div>
      `).join("");
    }

    function normalizeAwakenings(aw) {
      if (!aw) return [];
      if (Array.isArray(aw)) return aw;

      if (typeof aw === "object") {
        if (Array.isArray(aw.levels)) return aw.levels;

        const numKeys = Object.keys(aw).filter(k => /^\d+$/.test(k));
        if (numKeys.length) {
          return numKeys
            .sort((a,b)=> Number(a)-Number(b))
            .map(k => {
              const v = aw[k];
              if (typeof v === "object" && v) return { level: Number(k), ...v };
              return { level: Number(k), effect: v };
            });
        }
      }
      return [];
    }

    function awakenRowEffect(x) {
      if (x == null) return "";
      if (typeof x === "string") return x;
      if (typeof x === "number" || typeof x === "boolean") return String(x);
      if (typeof x === "object") {
        const eff = pick(x, "effect", "effects", "desc", "description", "text");
        if (typeof eff === "string") return eff;
        return JSON.stringify(x, null, 2);
      }
      return String(x);
    }

    function renderAwakenings(detail) {
      const aw = pick(detail, "awakenings", "awakening");
      const rows = normalizeAwakenings(aw);

      if (!rows.length) return `<div class="detail-empty">각성 데이터 없음</div>`;

      const tbody = rows.map((x, idx) => {
        const lvl = pick(x, "level", "lv", "stage") ?? (idx + 1);
        const eff = awakenRowEffect(x);
        return `<tr><td style="width:110px;font-weight:950;">Lv.${escapeHtml(String(lvl))}</td><td>${escapeHtml(eff)}</td></tr>`;
      }).join("");

      return `
        <table class="awak-table">
          <thead><tr><th style="width:110px;">레벨</th><th>효과</th></tr></thead>
          <tbody>${tbody}</tbody>
        </table>
      `;
    }

    function renderMemoryCard(detail) {
      const mem = pick(detail, "memoryCard", "memory_card");
      if (isEmpty(mem)) return `<div class="detail-empty">메모리카드 데이터 없음</div>`;

      if (typeof mem !== "object") {
        return `<div class="detail-empty">${escapeHtml(String(mem))}</div>`;
      }

      const name = pick(mem, "name", "title") || "Memory Card";
      const desc = pick(mem, "description", "desc", "text") || "";
      const effects = pick(mem, "effects", "effect");

      let effectsHtml = "";
      if (Array.isArray(effects)) {
        effectsHtml = `
          <table class="awak-table">
            <thead><tr><th style="width:110px;">순번</th><th>효과</th></tr></thead>
            <tbody>
              ${effects.map((e, i) => `<tr><td style="font-weight:950;">${i+1}</td><td>${escapeHtml(typeof e === "string" ? e : JSON.stringify(e, null, 2))}</td></tr>`).join("")}
            </tbody>
          </table>
        `;
      } else if (effects && typeof effects === "object") {
        effectsHtml = renderKV(effects);
      } else if (typeof effects === "string") {
        effectsHtml = `<div class="card-desc">${escapeHtml(effects)}</div>`;
      } else {
        effectsHtml = renderKV(mem);
      }

      return `
        <div class="card">
          <div class="card-title"><span>${escapeHtml(String(name))}</span></div>
          ${desc ? `<div class="card-desc">${escapeHtml(String(desc))}</div>` : ""}
          <div style="margin-top:10px;">${effectsHtml}</div>
        </div>
      `;
    }

    function renderPanel(id, html, active=false) {
      return `<div class="tab-panel ${active ? "active" : ""}" data-panel="${escapeHtml(id)}">${html}</div>`;
    }

    function renderDetailTabs(detail) {
      const tabs = [
        { id: "skills", label: "스킬", content: renderSkills(detail) },
        { id: "awakenings", label: "각성", content: renderAwakenings(detail) },
        { id: "memory", label: "메모리카드", content: renderMemoryCard(detail) },
      ];

      const firstActive = "skills";

      const tabBtns = tabs.map(t =>
        `<button type="button" class="tab-btn ${t.id === firstActive ? "active" : ""}" data-tab="${escapeHtml(t.id)}">${escapeHtml(t.label)}</button>`
      ).join("");

      const panels = tabs.map(t => renderPanel(t.id, t.content, t.id === firstActive)).join("");
      const raw = `<details class="raw"><summary>Raw JSON 보기</summary><pre>${escapeHtml(JSON.stringify(detail || {}, null, 2))}</pre></details>`;

      return `
        <div class="tabs">
          <div class="tab-bar">${tabBtns}</div>
          <div class="tab-body">${panels}${raw}</div>
        </div>
      `;
    }

    function bindTabEvents() {
      const root = document.getElementById("modalBody");
      if (!root) return;

      root.onclick = (e) => {
        const btn = e.target.closest(".tab-btn");
        if (!btn) return;

        const tab = btn.dataset.tab;
        if (!tab) return;

        root.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
        root.querySelectorAll(".tab-panel").forEach(p => p.classList.toggle("active", p.dataset.panel === tab));
      };
    }

    // ===== 모달 =====
    const backdrop = document.getElementById("modalBackdrop");
    const modalBody = document.getElementById("modalBody");
    const modalTitle = document.getElementById("modalTitle");
    const modalClose = document.getElementById("modalClose");

    function openModal() {
      backdrop.classList.add("show");
      backdrop.setAttribute("aria-hidden", "false");
    }
    function closeModal() {
      backdrop.classList.remove("show");
      backdrop.setAttribute("aria-hidden", "true");
      modalBody.innerHTML = `<div class="modal-loading">Loading…</div>`;
    }
    modalClose.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape" && backdrop.classList.contains("show")) closeModal(); });

    // (2) 중국어명은 title로 대체하지 않고 “이름 옆”에 표시
    function setModalTitle(name, cn){
      const safeName = escapeHtml(name || "Character");
      const safeCn = cn ? escapeHtml(cn) : "";
      modalTitle.innerHTML = safeCn ? `${safeName}<span class="cn">${safeCn}</span>` : safeName;
    }

    async function fetchAndOpen(cid) {
      openModal();
      modalBody.innerHTML = `<div class="modal-loading">Loading…</div>`;
      try {
        const r = await fetch(`/zones/zone-nova/characters/${encodeURIComponent(cid)}`, { cache: "no-store" });
        const j = await r.json();
        if (!j.ok) {
          modalBody.innerHTML = `<div class="detail-empty">불러오기 실패: ${escapeHtml(j.error || "unknown")}</div>`;
          return;
        }

        const detail = j.detail || {};

        const name = pick(detail, "name") || j.character?.name || j.id || "Character";
        const cn = pick(detail, "chineseName", "chinesename", "chinessname", "cnName", "cn_name");

        setModalTitle(name, cn);

        modalBody.innerHTML = renderDetailTabs(detail);
        bindTabEvents();
      } catch (e) {
        modalBody.innerHTML = `<div class="detail-empty">불러오기 실패: ${escapeHtml(String(e))}</div>`;
      }
    }

    // ===== 렌더 =====
    const chars = dedupeById(CHARS_RAW || []);
    document.getElementById("sourceHint").textContent = "characters_meta/characters.json + characters_ko(상세)";

    const $tbody = document.getElementById("tbody");
    const $q = document.getElementById("q");
    const $rarity = document.getElementById("rarityFilter");
    const $elem = document.getElementById("elemFilter");
    const $faction = document.getElementById("factionFilter");
    const $class = document.getElementById("classFilter");
    const $role = document.getElementById("roleFilter");

    function uniqSorted(values){
      return Array.from(new Set(values.filter(v => v && v !== "-")))
        .sort((a,b) => a.localeCompare(b));
    }

    function fillSelect(sel, values){
      for (const v of values){
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      }
    }

    const elems = uniqSorted(chars.map(c => normalizeElem(c.element)));
    const facts = uniqSorted(chars.map(c => normalizeFaction(c.faction)));
    const classes = uniqSorted(chars.map(c => classLabel(c.class)));
    const roles = uniqSorted(chars.map(c => roleLabel(c.role, c.class)));

    fillSelect($elem, elems);
    fillSelect($faction, facts);
    fillSelect($class, classes);
    fillSelect($role, roles);

    function matchFilters(c){
      const q = ($q.value || "").trim().toLowerCase();
      const rarityV = ($rarity.value || "").trim().toUpperCase();
      const elemV = ($elem.value || "").trim();
      const factionV = ($faction.value || "").trim();
      const classV = ($class.value || "").trim();
      const roleV = ($role.value || "").trim();

      const name = (c.name || "").toString().toLowerCase();
      const id = (c.id || "").toString().toLowerCase();
      const faction = normalizeFaction(c.faction).toLowerCase();
      const elem = normalizeElem(c.element);
      const cls = classLabel(c.class);
      const role = roleLabel(c.role, c.class);

      if (q){
        const ok = name.includes(q) || id.includes(q) || faction.includes(q) || elem.toLowerCase().includes(q);
        if (!ok) return false;
      }
      if (rarityV && (c.rarity || "-").toString().toUpperCase() !== rarityV) return false;
      if (elemV && elem !== elemV) return false;
      if (factionV && normalizeFaction(c.faction) !== factionV) return false;
      if (classV && cls !== classV) return false;
      if (roleV && role !== roleV) return false;

      return true;
    }

    function sortChars(list){
      return list.slice().sort((a,b) => {
        const ra = RARITY_ORDER[(a.rarity || "-").toString().toUpperCase()] ?? 0;
        const rb = RARITY_ORDER[(b.rarity || "-").toString().toUpperCase()] ?? 0;
        if (rb !== ra) return rb - ra;

        const na = (a.name || a.id || "").toString();
        const nb = (b.name || b.id || "").toString();
        return na.localeCompare(nb);
      });
    }

    function render(){
      const filtered = sortChars(chars.filter(matchFilters));
      const rows = filtered.map(c => {
        const cid = c.id;
        const nm = c.name || cid;

        const elem = normalizeElem(c.element);
        const elemPill = (elem && elem !== "-")
          ? `<span class="pill pill-elem ${elemClass(elem)}">${c.element_icon ? `<img src="${escapeHtml(c.element_icon)}" alt="">` : ""}${escapeHtml(elem)}</span>`
          : `<span class="pill pill-none">-</span>`;

        const faction = normalizeFaction(c.faction);
        const factionPill = (faction && faction !== "-")
          ? `<span class="pill pill-neutral">${escapeHtml(faction)}</span>`
          : `<span class="pill pill-none">-</span>`;

        const cls = classLabel(c.class);
        const clsIcon = c.class_icon ? `<img src="${escapeHtml(c.class_icon)}" alt="">` : "";
        const clsPill = (cls && cls !== "-")
          ? `<span class="pill pill-neutral">${clsIcon}${escapeHtml(cls)}</span>`
          : `<span class="pill pill-none">-</span>`;

        const role = roleLabel(c.role, c.class);
        const rolePill = (role && role !== "-")
          ? `<span class="pill pill-neutral">${escapeHtml(role)}</span>`
          : `<span class="pill pill-none">-</span>`;

        const rar = (c.rarity || "-").toString().toUpperCase();
        const rarPill = `<span class="pill ${rarityPillClass(rar)}">${escapeHtml(rar)}</span>`;

        const img = c.image
          ? `<img class="char-img" src="${escapeHtml(c.image)}" alt="">`
          : `<div class="char-img"></div>`;

        return `
          <tr>
            <td class="col-check"><input class="chk-owned" type="checkbox" data-cid="${escapeHtml(cid)}"></td>
            <td>
              <div class="char-cell clickable" data-cid="${escapeHtml(cid)}">
                ${img}
                <div class="char-name">${escapeHtml(nm)}</div>
              </div>
            </td>
            <td class="col-elem">${elemPill}</td>
            <td class="col-faction">${factionPill}</td>
            <td class="col-class">${clsPill}</td>
            <td class="col-role">${rolePill}</td>
            <td class="col-rarity">${rarPill}</td>
          </tr>
        `;
      }).join("");

      $tbody.innerHTML = rows || `<tr><td colspan="7" style="padding:18px;color:rgba(255,255,255,.70);font-weight:800;">표시할 캐릭터가 없습니다.</td></tr>`;
    }

    [$q, $rarity, $elem, $faction, $class, $role].forEach(el => {
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    document.getElementById("btnAll").addEventListener("click", () => {
      document.querySelectorAll(".chk-owned").forEach(x => x.checked = true);
    });
    document.getElementById("btnNone").addEventListener("click", () => {
      document.querySelectorAll(".chk-owned").forEach(x => x.checked = false);
    });

    document.addEventListener("click", (e) => {
      const chk = e.target.closest(".chk-owned");
      if (chk) return;

      const cell = e.target.closest(".char-cell.clickable");
      if (!cell) return;

      const cid = cell.dataset.cid;
      if (cid) fetchAndOpen(cid);
    });

    render();
  </script>
</body>
</html>

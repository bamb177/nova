<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="page">
    <header class="topbar">
      <div class="topbar__left">
        <div class="brand">{{ title }}</div>
        <div class="meta">
          <span>캐릭터: <b>{{ cache_count }}</b></span>
          <span class="dot">•</span>
          <span>보스: <b>{{ boss_count }}</b></span>
          <span class="dot">•</span>
          <span>갱신: <b>{{ last_refresh }}</b></span>
        </div>
      </div>
      <div class="topbar__right">
        <a class="btn" href="/refresh">Refresh</a>
      </div>
    </header>

    {% if error %}
      <div class="alert">데이터 로딩 오류: {{ error }}</div>
    {% endif %}

    <section class="panel">
      <div class="panel__head">
        <div class="panel__title">보유 캐릭터</div>
        <div class="panel__tools">
          <input id="q" class="input" placeholder="이름/속성/특성/클래스 검색" />
          <span class="hint" id="count"></span>
        </div>
      </div>

      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th class="col-check">선택</th>
              <th class="col-char">캐릭터</th>
              <th class="col-elem">속성</th>
              <th class="col-faction">Faction(특성)</th>
              <th class="col-class">클래스</th>
              <th class="col-role">역할</th>
              <th class="col-rarity">등급</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const CHARS = {{ chars_json|safe }};
    const $tbody = document.getElementById("tbody");
    const $q = document.getElementById("q");
    const $count = document.getElementById("count");

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function rarityRank(r) {
      const x = String(r || "-").toUpperCase();
      if (x === "SSR") return 0;
      if (x === "SR") return 1;
      if (x === "R") return 2;
      return 9;
    }

    function sortChars(list) {
      // 요구사항: 등급 1차, 이름 2차
      return [...list].sort((a, b) => {
        const ra = rarityRank(a.rarity), rb = rarityRank(b.rarity);
        if (ra !== rb) return ra - rb;
        const na = String(a.name || "").toLowerCase();
        const nb = String(b.name || "").toLowerCase();
        if (na < nb) return -1;
        if (na > nb) return 1;
        return String(a.id || "").localeCompare(String(b.id || ""));
      });
    }

    function badge(html, cls) {
      return `<span class="badge ${cls}">${html}</span>`;
    }

    function renderRow(c) {
      const img = c.image ? `<img class="avatar" src="${escapeHtml(c.image)}" alt="">` : `<div class="avatar avatar--empty"></div>`;
      const elem = c.element && c.element !== "-" ? badge(escapeHtml(c.element), `badge--elem badge--${String(c.element).toLowerCase()}`) : badge("-", "badge--muted");
      const faction = c.faction ? badge(escapeHtml(c.faction), "badge--faction") : badge("-", "badge--muted");

      const clsLabel = c.class_display || c.class || "-";
      const roleLabel = c.role_display || c.role || "-";

      const cls = clsLabel && clsLabel !== "-" ? badge(escapeHtml(clsLabel), "badge--class") : badge("-", "badge--muted");
      const role = roleLabel && roleLabel !== "-" ? `<span class="role">${escapeHtml(roleLabel)}</span>` : `<span class="role role--muted">-</span>`;

      const rar = String(c.rarity || "-").toUpperCase();
      const rarityBadgeCls = (rar === "SSR") ? "badge--rarity badge--ssr" :
                             (rar === "SR")  ? "badge--rarity badge--sr" :
                             (rar === "R")   ? "badge--rarity badge--r" : "badge--rarity badge--muted";
      const rarity = badge(escapeHtml(rar), rarityBadgeCls);

      return `
        <tr>
          <td class="col-check"><input type="checkbox" class="chk" data-id="${escapeHtml(c.id)}"></td>
          <td class="col-char">
            <div class="char">
              ${img}
              <div class="char__text">
                <div class="char__name">${escapeHtml(c.name || c.id)}</div>
                <div class="char__sub">${escapeHtml(c.id)}</div>
              </div>
            </div>
          </td>
          <td class="col-elem">${elem}</td>
          <td class="col-faction">${faction}</td>
          <td class="col-class">${cls}</td>
          <td class="col-role">${role}</td>
          <td class="col-rarity">${rarity}</td>
        </tr>
      `;
    }

    function applyFilter(list, q) {
      const k = String(q || "").trim().toLowerCase();
      if (!k) return list;

      return list.filter(c => {
        const s = [
          c.name, c.id, c.element, c.faction, c.class_display, c.role_display, c.rarity
        ].join(" ").toLowerCase();
        return s.includes(k);
      });
    }

    function render() {
      const list = sortChars(applyFilter(CHARS, $q.value));
      $tbody.innerHTML = list.map(renderRow).join("");
      $count.textContent = `${list.length} / ${CHARS.length}`;
    }

    $q.addEventListener("input", render);
    render();
  </script>
</body>
</html>

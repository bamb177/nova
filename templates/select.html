<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="title">
        <h1>{{ title }}</h1>
        <div class="meta">
          <span>캐릭터: {{ cache_count }}</span>
          <span>보스: {{ boss_count }}</span>
          <span>갱신: {{ last_refresh }}</span>
          {% if error %}
            <span class="error">ERROR: {{ error }}</span>
          {% endif %}
        </div>
      </div>
      <div class="actions">
        <a class="btn" href="/refresh">Refresh</a>
      </div>
    </header>

    <section class="panel">
      <div class="panel-head">
        <div class="panel-title">캐릭터 목록</div>
        <div class="panel-sub">체크박스로 보유(Owned) 캐릭터를 선택하세요.</div>
      </div>

      <div class="table-wrap">
        <table class="char-table" id="charTable">
          <thead>
            <tr>
              <th class="col-check">선택</th>
              <th class="col-char">캐릭터</th>
              <th class="col-elem">속성</th>
              <th class="col-faction">Faction(특성)</th>
              <th class="col-class">클래스</th>
              <th class="col-role">역할</th>
              <th class="col-rarity">등급</th>
            </tr>
          </thead>
          <tbody id="charTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const CHARS = {{ chars_json|safe }};

    function roleLabel(role) {
      const r = (role || "-").toString().toLowerCase();
      if (r === "dps") return "DPS";              // 요청 3
      if (r === "-" || r === "") return "-";
      return r.charAt(0).toUpperCase() + r.slice(1);
    }

    function classLabel(cls) {
      const c = (cls || "-").toString().toLowerCase();
      if (c === "debuffer") return "Disruptor";   // 요청 4 (표기 변경)
      if (c === "-" || c === "") return "-";
      return c.charAt(0).toUpperCase() + c.slice(1);
    }

    function rarityClass(r) {
      const x = (r || "-").toString().toUpperCase();
      if (x === "SSR") return "rarity ssr";
      if (x === "SR")  return "rarity sr";        // 요청 7 (CSS에서 주황 그라데이션)
      if (x === "R")   return "rarity r";
      return "rarity none";
    }

    function badge(text, iconUrl, extraClass="") {
      const icon = iconUrl ? `<img class="badge-icon" src="${iconUrl}" alt="" />` : "";
      return `<span class="badge ${extraClass}">${icon}<span class="badge-text">${text || "-"}</span></span>`;
    }

    function render() {
      const tbody = document.getElementById("charTbody");
      tbody.innerHTML = "";

      for (const c of CHARS) {
        const img = c.image
          ? `<img class="avatar" src="${c.image}" alt="" />`
          : `<div class="avatar placeholder"></div>`;

        const name = c.name || c.id || "-";
        const elem = badge(c.element || "-", c.element_icon, "badge-elem");
        const faction = (c.faction || "-");
        const cls = badge(classLabel(c.class), c.class_icon, "badge-class");
        const role = roleLabel(c.role);
        const rarity = `<span class="${rarityClass(c.rarity)}">${(c.rarity || "-").toString().toUpperCase()}</span>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-check"><input type="checkbox" class="chk-owned" data-id="${c.id}" /></td>
          <td class="col-char">
            <div class="char-cell">
              ${img}
              <div class="char-name">${name}</div>
            </div>
          </td>
          <td class="col-elem">${elem}</td>
          <td class="col-faction"><span class="text">${faction}</span></td>
          <td class="col-class">${cls}</td>
          <td class="col-role"><span class="text">${role}</span></td>
          <td class="col-rarity">${rarity}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    render();
  </script>
</body>
</html>

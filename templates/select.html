<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>

  <!-- 공통/페이지 CSS 분리 유지 -->
  <link rel="stylesheet" href="/css/select.css?v={{ last_refresh }}" />

  <!-- ✅ Tier 결과 카드 이미지 + PC 폭 확장 오버라이드 -->
  <style>
    /* (2) 전체 페이지 폭 확장 (PC) */
    @media (min-width: 1100px){
      .wrap{ max-width: 1600px !important; }
    }

    /* (1) 등급표 파티 카드: 좌측 초상화 + 이름 */
    .tier-card-top{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .tier-portrait{
      width:44px;
      height:44px;
      border-radius:12px;
      object-fit:cover;
      flex:0 0 auto;
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .tier-portrait-empty{
      display:inline-block;
    }
    .tier-name{
      font-weight: 900;
      letter-spacing: .2px;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="title">
      <div class="title-row">
        <h1>{{ title }}</h1>
        <a class="navbtn" href="/runes">룬 정보</a>
        <div class="meta-inline">캐릭터 {{ cache_count }}명</div>
        <div class="refresh">갱신 {{ last_refresh }}</div>
      </div>
    </div>
  </div>

  {% if error %}
    <div class="error">로딩 오류: {{ error }}</div>
  {% endif %}

  <div class="wrap">

    <div class="panel">
      <!-- ===== Filters ===== -->
      <div class="filters">
        <input class="input" id="q" placeholder="검색 (이름)" />

        <select class="select" id="rarity">
          <option value="">등급(전체)</option>
          <option value="SSR">SSR</option>
          <option value="SR">SR</option>
          <option value="R">R</option>
        </select>

        <select class="select" id="element">
          <option value="">속성(전체)</option>
        </select>

        <select class="select" id="faction">
          <option value="">파벌(전체)</option>
        </select>

        <select class="select" id="cls">
          <option value="">클래스(전체)</option>
        </select>

        <button class="btn" id="btnClear" type="button">초기화</button>
        <a class="btn" href="/refresh">강제 갱신</a>
      </div>

      <!-- ===== List ===== -->
      <div id="list" class="list"></div>
    </div>

    <!-- ===== Tier Party Result ===== -->
    <div class="panel tier-section">
      <h2>추천 파티</h2>
      <div id="tierPartyResult"></div>
    </div>

  </div>

  <!-- ===== Modal ===== -->
  <div class="modal" id="modal" hidden>
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="modal-title">
          <div id="modalTitle" class="modal-title-main"></div>
          <div id="modalSub" class="modal-title-sub"></div>
        </div>
        <button class="modal-close" id="modalClose" aria-label="Close" type="button">✕</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // ===== Data bootstrap =====
    const chars = {{ chars_json|safe }};

    // ===== Utilities =====
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function pick(obj, ...keys){
      for (const k of keys){
        if (obj && obj[k] != null) return obj[k];
      }
      return null;
    }

    function uniq(arr){
      return [...new Set(arr.filter(Boolean))];
    }

    function buildOptions(){
      const els = uniq(chars.map(c => c.element));
      const fac = uniq(chars.map(c => c.faction));
      const cls = uniq(chars.map(c => c.class));

      const set = (id, values) => {
        const sel = document.getElementById(id);
        if (!sel) return;
        const cur = sel.value;
        const opts = ['<option value="">'+sel.options[0].text+'</option>']
          .concat(values.sort().map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
        sel.innerHTML = opts.join("");
        sel.value = cur;
      };

      set("element", els);
      set("faction", fac);
      set("cls", cls);
    }

    // ===== Render list =====
    function renderList(){
      const q = (document.getElementById("q")?.value || "").trim().toLowerCase();
      const rarity = document.getElementById("rarity")?.value || "";
      const element = document.getElementById("element")?.value || "";
      const faction = document.getElementById("faction")?.value || "";
      const cls = document.getElementById("cls")?.value || "";

      const out = chars.filter(c => {
        if (q && !(c.name || "").toLowerCase().includes(q)) return false;
        if (rarity && c.rarity !== rarity) return false;
        if (element && c.element !== element) return false;
        if (faction && c.faction !== faction) return false;
        if (cls && c.class !== cls) return false;
        return true;
      });

      const box = document.getElementById("list");
      if (!box) return;

      if (!out.length){
        box.innerHTML = `<div class="empty">검색 결과가 없습니다.</div>`;
        return;
      }

      box.innerHTML = out.map(c => {
        const img = c.image
          ? `<img class="portrait" src="${escapeHtml(c.image)}" alt="">`
          : `<div class="portrait portrait-empty"></div>`;

        const elemIcon = c.element_icon
          ? `<img class="mini-ico" src="${escapeHtml(c.element_icon)}" alt="">`
          : "";
        const clsIcon = c.class_icon
          ? `<img class="mini-ico" src="${escapeHtml(c.class_icon)}" alt="">`
          : "";

        const badges = `
          <span class="pill pill-neutral">${escapeHtml(c.rarity || "-")}</span>
          <span class="pill pill-neutral">${elemIcon}${escapeHtml(c.element || "-")}</span>
          <span class="pill pill-neutral">${escapeHtml(c.faction || "-")}</span>
          <span class="pill pill-neutral">${clsIcon}${escapeHtml(c.class || "-")}</span>
        `;

        return `
          <div class="card" data-id="${escapeHtml(c.id)}">
            <div class="card-top">
              ${img}
              <div class="card-main">
                <div class="card-name">${escapeHtml(c.name || c.id)}</div>
                <div class="card-badges">${badges}</div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    // ===== Modal controls =====
    const modal = document.getElementById("modal");
    const modalBody = document.getElementById("modalBody");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");

    function openModal(){
      modal.hidden = false;
      document.body.style.overflow = "hidden";
    }
    function closeModal(){
      modal.hidden = true;
      document.body.style.overflow = "";
      modalBody.innerHTML = "";
    }
    document.getElementById("modalBackdrop")?.addEventListener("click", closeModal);
    document.getElementById("modalClose")?.addEventListener("click", closeModal);
    window.addEventListener("keydown", (e) => {
      if (!modal.hidden && e.key === "Escape") closeModal();
    });

    function setModalTitle(name, cn){
      modalTitle.textContent = name || "";
      modalSub.textContent = cn ? `(${cn})` : "";
    }

    // ===== Click list -> fetch detail =====
    document.getElementById("list")?.addEventListener("click", (e) => {
      const card = e.target.closest(".card");
      if (!card) return;
      const cid = card.dataset.id;
      if (!cid) return;
      openCharacterDetail(cid);
    });

    async function openCharacterDetail(cid){
      openModal();
      modalBody.innerHTML = `<div class="modal-loading">Loading…</div>`;
      try {
        const r = await fetch(`/zones/zone-nova/characters/${encodeURIComponent(cid)}`, { cache: "no-store" });
        const j = await r.json();
        if (!j.ok) {
          modalBody.innerHTML = `<div class="detail-empty">불러오기 실패: ${escapeHtml(j.error || "unknown")}</div>`;
          return;
        }

        const detail = j.detail || {};
        const name = pick(detail, "name") || j.character?.name || j.id || "Character";
        const cn = pick(detail, "chineseName", "chinesename", "chinessname", "cnName", "cn_name");

        setModalTitle(name, cn);
        const runeReco = j.rune_reco || null;
        const charMeta = j.character || null;
        modalBody.innerHTML = renderDetailTabs(detail, runeReco, charMeta);
        bindTabEvents();
      } catch (e) {
        modalBody.innerHTML = `<div class="detail-empty">불러오기 실패: ${escapeHtml(String(e))}</div>`;
      }
    }

    // ===== Detail renderers =====
    function renderPanel(id, content, active){
      return `<div class="tab-panel ${active ? "active" : ""}" data-panel="${escapeHtml(id)}">${content}</div>`;
    }

    function renderSkills(detail){
      const skills = detail?.skills;
      if (!skills) return `<div class="detail-empty">스킬 정보 없음</div>`;

      const entries = Array.isArray(skills) ? skills : Object.values(skills);
      return entries.map((s, idx) => {
        const name = pick(s, "name") || `Skill ${idx+1}`;
        const desc = pick(s, "description", "desc") || "";
        return `
          <div class="detail-card">
            <h3>${escapeHtml(name)}</h3>
            <div class="detail-text">${escapeHtml(desc)}</div>
          </div>
        `;
      }).join("");
    }

    function renderAwakenings(detail){
      const aw = detail?.awakenings;
      if (!aw) return `<div class="detail-empty">각성 정보 없음</div>`;

      const arr = Array.isArray(aw) ? aw : Object.values(aw);
      return arr.map((a, idx) => {
        const name = pick(a, "name") || `Awakening ${idx+1}`;
        const effects = pick(a, "effects") || pick(a, "effect") || "";
        const txt = Array.isArray(effects) ? effects.join("\n") : String(effects);
        return `
          <div class="detail-card">
            <h3>${escapeHtml(name)}</h3>
            <pre class="detail-pre">${escapeHtml(txt)}</pre>
          </div>
        `;
      }).join("");
    }

    function renderMemoryCard(detail){
      const mc = detail?.memoryCard || detail?.memory_card;
      if (!mc) return `<div class="detail-empty">메모리카드 정보 없음</div>`;

      const name = pick(mc, "name") || "Memory Card";
      const effects = pick(mc, "effects") || pick(mc, "effect") || "";
      const txt = Array.isArray(effects) ? effects.join("\n") : String(effects);

      return `
        <div class="detail-card">
          <h3>${escapeHtml(name)}</h3>
          <pre class="detail-pre">${escapeHtml(txt)}</pre>
        </div>
      `;
    }

    // ===== Rune Recommendation (Auto/Override) =====
    function renderRuneReco(runeReco, charMeta, detail){
      if (!runeReco || !Array.isArray(runeReco.builds) || !runeReco.builds.length){
        return `<div class="detail-empty">추천 룬 데이터가 없습니다.</div>`;
      }

      const builds = runeReco.builds;

      const tabs = builds.map((b, i) => {
        const label = b?.title || (i === 0 ? "추천" : `대체안 ${i}`);
        return `<button type="button" class="rune-tab-btn ${i===0 ? "is-active":""}" data-rune-tab="${i}">${escapeHtml(label)}</button>`;
      }).join("");

      const panels = builds.map((b, i) => {
        return `
          <div class="rune-tab-panel ${i===0 ? "is-active":""}" data-rune-panel="${i}">
            ${renderRuneBuild(b, runeReco, charMeta, detail)}
          </div>
        `;
      }).join("");

      const badge = runeReco.mode === "override"
        ? `<span class="pill pill-neutral">override</span>`
        : `<span class="pill pill-neutral">auto</span>`;

      const prof = runeReco.profile || {};
      const profLine = (runeReco.mode === "auto" && prof.archetype)
        ? `<div class="rune-prof">
             ${badge}
             <span class="pill pill-neutral">${escapeHtml(String(prof.archetype))}</span>
             <span class="pill pill-neutral">${escapeHtml(String(prof.scaling || "MIX"))}</span>
           </div>`
        : `<div class="rune-prof">${badge}</div>`;

      return `
        <div class="rune-wrap">
          <div class="rune-head">
            <div class="rune-title">추천 룬</div>
            ${profLine}
          </div>

          <div class="rune-build-tabs">
            ${tabs}
          </div>

          <div class="rune-build-body">
            ${panels}
          </div>
        </div>
      `;
    }

    function renderRuneBuild(build, runeReco, charMeta, detail){
      const setPlan = Array.isArray(build?.setPlan) ? build.setPlan : [];
      const slots = build?.slots || {};
      const substats = Array.isArray(build?.substats) ? build.substats : [];
      const notes = Array.isArray(build?.notes) ? build.notes : [];

      const setHtml = setPlan.length
        ? `<div class="rune-sets">
            ${setPlan.map(sp => {
              const icon = sp?.icon
                ? `<img class="rune-set-icon" src="${escapeHtml(sp.icon)}" alt="">`
                : `<div class="rune-set-icon rune-set-icon-empty"></div>`;
              const pieces = sp?.pieces ? `<span class="rune-set-pieces">${escapeHtml(String(sp.pieces))}pc</span>` : "";
              return `
                <div class="rune-set-pill" title="${escapeHtml(String(sp.set || ""))}">
                  ${icon}
                  <div class="rune-set-meta">
                    <div class="rune-set-name">${escapeHtml(String(sp.set || "-"))}</div>
                    <div class="rune-set-sub">${pieces}</div>
                  </div>
                </div>
              `;
            }).join("")}
          </div>`
        : `<div class="detail-empty">세트 정보 없음</div>`;

      const slotHtml = renderRuneSlots(slots);

      const subHtml = substats.length
        ? `<ul class="rune-list">${substats.map(s => `<li>${escapeHtml(String(s))}</li>`).join("")}</ul>`
        : `<div class="muted">부옵 우선순위 정보 없음</div>`;

      const noteHtml = notes.length
        ? `<ul class="rune-notes">${notes.map(s => `<li>${escapeHtml(String(s))}</li>`).join("")}</ul>`
        : "";

      return `
        <div class="rune-build-card">
          ${setHtml}

          <div class="rune-section">
            <h3>슬롯별 메인 스탯</h3>
            ${slotHtml}
          </div>

          <div class="rune-section">
            <h3>부옵 우선순위</h3>
            ${subHtml}
          </div>

          ${noteHtml ? `<div class="rune-section"><h3>주의/비고</h3>${noteHtml}</div>` : ""}
        </div>
      `;
    }

    function renderRuneSlots(slots){
      const get = (k) => {
        const v = slots?.[String(k)];
        if (Array.isArray(v)) return v;
        if (typeof v === "string") return [v];
        return [];
      };

      const items = [1,2,3,4,5,6].map(pos => {
        const lines = get(pos);
        const body = lines.length
          ? lines.map((x,i)=> `<div class="rune-slot-line ${i===0 ? "main":""}">${escapeHtml(String(x))}</div>`).join("")
          : `<div class="muted">-</div>`;

        return `
          <div class="rune-slot">
            <div class="rune-slot-h">Slot ${pos}</div>
            <div class="rune-slot-b">${body}</div>
          </div>
        `;
      }).join("");

      return `<div class="rune-slots">${items}</div>`;
    }

    function renderDetailTabs(detail, runeReco, charMeta) {
      const tabs = [
        { id: "skills", label: "스킬", content: renderSkills(detail) },
        { id: "awakenings", label: "각성", content: renderAwakenings(detail) },
        { id: "memory", label: "메모리카드", content: renderMemoryCard(detail) },
        { id: "runes", label: "추천 룬", content: renderRuneReco(runeReco, charMeta, detail) },
      ];
      const firstActive = "skills";

      const tabBtns = tabs.map(t =>
        `<button type="button" class="tab-btn ${t.id === firstActive ? "active" : ""}" data-tab="${escapeHtml(t.id)}">${escapeHtml(t.label)}</button>`
      ).join("");

      const panels = tabs.map(t => renderPanel(t.id, t.content, t.id === firstActive)).join("");
      const raw = `<details class="raw"><summary>Raw JSON 보기</summary><pre>${escapeHtml(JSON.stringify(detail || {}, null, 2))}</pre></details>`;

      return `
        <div class="tabs">
          <div class="tab-bar">${tabBtns}</div>
          <div class="tab-body">${panels}${raw}</div>
        </div>
      `;
    }

    function bindTabEvents() {
      const root = document.getElementById("modalBody");
      if (!root) return;

      root.onclick = (e) => {
        // 상단 탭(스킬/각성/메모리/추천룬)
        const btn = e.target.closest(".tab-btn");
        if (btn){
          const tab = btn.dataset.tab;
          if (!tab) return;

          root.querySelectorAll(".tab-btn").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
          root.querySelectorAll(".tab-panel").forEach(p => p.classList.toggle("active", p.dataset.panel === tab));
          return;
        }

        // 룬 빌드 탭(추천/대체안)
        const rbtn = e.target.closest(".rune-tab-btn");
        if (rbtn){
          const idx = rbtn.dataset.runeTab;
          if (idx === undefined) return;

          root.querySelectorAll(".rune-tab-btn").forEach(b => b.classList.toggle("is-active", b.dataset.runeTab === idx));
          root.querySelectorAll(".rune-tab-panel").forEach(p => p.classList.toggle("is-active", p.dataset.runePanel === idx));
          return;
        }
      };
    }

    function renderRuneMini(c){
      const sets = c?.runes?.sets;
      if (!Array.isArray(sets) || !sets.length) return "";
      const title = sets.map(s => `${s?.set || ""} ${s?.pieces || ""}pc`).join(" + ");
      const icons = sets.slice(0, 2).map(s => {
        const icon = s?.icon;
        const pieces = s?.pieces ? `<span class="rune-mini-pc">${escapeHtml(String(s.pieces))}</span>` : "";
        if (icon){
          return `<div class="rune-mini">
                    <img class="rune-mini-icon" src="${escapeHtml(icon)}" alt="">
                    ${pieces}
                  </div>`;
        }
        return `<div class="rune-mini">
                  <div class="rune-mini-icon rune-mini-icon-empty"></div>
                  ${pieces}
                </div>`;
      }).join("");

      return `<div class="tier-runes" title="${escapeHtml(title)}">${icons}</div>`;
    }

    function renderTierPartyResult(rankMap, res){
      const box = document.getElementById("tierPartyResult");
      if (!box) return;

      if (!res.ok){
        box.innerHTML = `<div class="tier-error">${escapeHtml(res.msg || "실패")}</div>`;
        return;
      }

      const charsById = new Map(chars.map(c => [c.id, c]));

      const renderOneParty = (party) => {
        const cards = party.map(cid => {
          const c = charsById.get(cid);

          const img = c?.image
            ? `<img class="tier-portrait" src="${escapeHtml(c.image)}" alt="">`
            : `<div class="tier-portrait tier-portrait-empty"></div>`;

          return `
            <div class="tier-card">
              <div class="tier-card-top">
                ${img}
                <span class="tier-name">${escapeHtml(c?.name || cid)}</span>
              </div>
              <div class="tier-card-sub">
                <span class="pill pill-neutral">${escapeHtml(c?.element || "-")}</span>
                <span class="pill pill-neutral">${escapeHtml(c?.faction || "-")}</span>
                <span class="pill pill-neutral">${escapeHtml(c?.class || "-")}</span>
                ${renderRuneMini(c)}
              </div>
            </div>
          `;
        }).join("");

        return `<div class="tier-grid">${cards}</div>`;
      };

      const sections = res.data;
      const order = Array.isArray(res.order) && res.order.length
        ? res.order
        : ["Guild", "PVE", "PVP", "Rift"];

      const html = order.map(cat => {
        const parties = sections[cat] || [];
        if (!parties.length){
          return `
            <div class="tier-block">
              <h3>${escapeHtml(cat)}</h3>
              <div class="empty">결과 없음</div>
            </div>
          `;
        }

        return `
          <div class="tier-block">
            <h3>${escapeHtml(cat)}</h3>
            ${parties.map(p => renderOneParty(p)).join("")}
          </div>
        `;
      }).join("");

      box.innerHTML = html;
    }

    // ===== Init =====
    buildOptions();
    renderList();

    document.getElementById("q")?.addEventListener("input", renderList);
    document.getElementById("rarity")?.addEventListener("change", renderList);
    document.getElementById("element")?.addEventListener("change", renderList);
    document.getElementById("faction")?.addEventListener("change", renderList);
    document.getElementById("cls")?.addEventListener("change", renderList);

    document.getElementById("btnClear")?.addEventListener("click", () => {
      document.getElementById("q").value = "";
      document.getElementById("rarity").value = "";
      document.getElementById("element").value = "";
      document.getElementById("faction").value = "";
      document.getElementById("cls").value = "";
      renderList();
    });

    // (티어 추천 결과는 기존 로직이 어디선가 res를 생성해 호출한다고 가정)
    // renderTierPartyResult(rankMap, res);
  </script>
</body>
</html>

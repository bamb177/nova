<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div class="title">
        <h1>{{ title }}</h1>
        <div class="meta">
          <span>캐릭터: {{ cache_count }}</span>
          <span>보스: {{ boss_count }}</span>
          <span>갱신: {{ last_refresh }}</span>
          {% if error %}
            <span class="error">ERROR: {{ error }}</span>
          {% endif %}
        </div>
      </div>
      <div class="actions">
        <a class="btn" href="/refresh">Refresh</a>
      </div>
    </header>

    <section class="panel">
      <div class="panel-head">
        <div class="panel-title">캐릭터 목록</div>
        <div class="panel-sub">체크박스로 보유(Owned) 캐릭터를 선택하세요. 캐릭터를 클릭하면 상세 정보를 봅니다.</div>
      </div>

      <div class="table-wrap">
        <table class="char-table" id="charTable">
          <thead>
            <tr>
              <th class="col-check">선택</th>
              <th class="col-char">캐릭터</th>
              <th class="col-elem">속성</th>
              <th class="col-faction">특성</th>
              <th class="col-class">클래스</th>
              <th class="col-role">역할</th>
              <th class="col-rarity">등급</th>
            </tr>
          </thead>
          <tbody id="charTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- ✅ 상세 모달 -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">Character</div>
        <button class="modal-close" id="modalClose" type="button">×</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="modal-loading">Loading…</div>
      </div>
    </div>
  </div>

  <script>
    const CHARS = {{ chars_json|safe }};

    function valueSlug(v) {
      return (v || "")
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[’']/g, "")
        .replace(/[–—−]/g, "-")
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-]/g, "")
        .replace(/\-+/g, "-");
    }

    function roleLabel(role, cls) {
      const c = (cls || "-").toString().toLowerCase();
      if (c === "debuffer") return "DPS";
      const r = (role || "-").toString().toLowerCase();
      if (r === "dps") return "DPS";
      if (r === "-" || r === "") return "-";
      return r.charAt(0).toUpperCase() + r.slice(1);
    }

    function classLabel(cls) {
      const c = (cls || "-").toString().toLowerCase();
      if (c === "debuffer") return "Disruptor";
      if (c === "-" || c === "") return "-";
      return c.charAt(0).toUpperCase() + c.slice(1);
    }

    function rarityClass(r) {
      const x = (r || "-").toString().toUpperCase();
      if (x === "SSR") return "rarity ssr";
      if (x === "SR")  return "rarity sr";
      if (x === "R")   return "rarity r";
      return "rarity none";
    }

    function badge(kind, text, iconUrl) {
      const t = (text || "-").toString().trim();
      const slug = valueSlug(t);
      const icon = iconUrl ? `<img class="badge-icon" src="${iconUrl}" alt="" />` : "";
      return `
        <span class="badge badge-${kind} badge-${kind}--${slug}">
          ${icon}<span class="badge-text">${t || "-"}</span>
        </span>
      `;
    }

    function render() {
      const tbody = document.getElementById("charTbody");
      tbody.innerHTML = "";

      for (const c of CHARS) {
        const img = c.image
          ? `<img class="avatar" src="${c.image}" alt="" />`
          : `<div class="avatar placeholder"></div>`;

        const name = c.name || c.id || "-";

        const elem = badge("elem", c.element || "-", c.element_icon);
        const faction = badge("faction", c.faction || "-", null);
        const cls = badge("class", classLabel(c.class), c.class_icon);
        const role = badge("role", roleLabel(c.role, c.class), null);

        const rarity = `<span class="${rarityClass(c.rarity)}">${(c.rarity || "-").toString().toUpperCase()}</span>`;

        const tr = document.createElement("tr");
        tr.dataset.cid = c.id;
        tr.innerHTML = `
          <td class="col-check"><input type="checkbox" class="chk-owned" data-id="${c.id}" /></td>
          <td class="col-char">
            <div class="char-cell clickable" data-cid="${c.id}">
              ${img}
              <div class="char-name">${name}</div>
            </div>
          </td>
          <td class="col-elem">${elem}</td>
          <td class="col-faction">${faction}</td>
          <td class="col-class">${cls}</td>
          <td class="col-role">${role}</td>
          <td class="col-rarity">${rarity}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // ===== 모달 로직 =====
    const backdrop = document.getElementById("modalBackdrop");
    const modalBody = document.getElementById("modalBody");
    const modalTitle = document.getElementById("modalTitle");
    const modalClose = document.getElementById("modalClose");

    function openModal() {
      backdrop.classList.add("show");
      backdrop.setAttribute("aria-hidden", "false");
    }
    function closeModal() {
      backdrop.classList.remove("show");
      backdrop.setAttribute("aria-hidden", "true");
      modalBody.innerHTML = `<div class="modal-loading">Loading…</div>`;
    }

    modalClose.addEventListener("click", closeModal);
    backdrop.addEventListener("click", (e) => {
      if (e.target === backdrop) closeModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && backdrop.classList.contains("show")) closeModal();
    });

    function kvTable(obj) {
      const rows = Object.entries(obj || {}).map(([k, v]) => {
        const vv = (typeof v === "object") ? JSON.stringify(v) : String(v);
        return `<tr><td class="kv-k">${k}</td><td class="kv-v">${vv}</td></tr>`;
      }).join("");
      return `<table class="kv"><tbody>${rows}</tbody></table>`;
    }

    function renderDetail(resp) {
      const c = resp.character || {};
      const d = resp.detail;

      modalTitle.textContent = c.name || c.id || "Character";

      const header = `
        <div class="detail-head">
          <div class="detail-left">
            ${c.image ? `<img class="detail-avatar" src="${c.image}" alt="" />` : `<div class="detail-avatar placeholder"></div>`}
          </div>
          <div class="detail-right">
            <div class="detail-name">${c.name || c.id}</div>
            <div class="detail-badges">
              ${badge("elem", c.element || "-", c.element_icon)}
              ${badge("faction", c.faction || "-", null)}
              ${badge("class", classLabel(c.class), c.class_icon)}
              ${badge("role", roleLabel(c.role, c.class), null)}
              <span class="${rarityClass(c.rarity)}">${(c.rarity || "-").toString().toUpperCase()}</span>
            </div>
            <div class="detail-sub">ID: ${c.id || "-"}</div>
            ${resp.detail_source ? `<div class="detail-sub">Detail: ${resp.detail_source}</div>` : `<div class="detail-sub">Detail: (none)</div>`}
          </div>
        </div>
      `;

      if (!d) {
        modalBody.innerHTML = header + `<div class="detail-empty">상세 데이터 파일이 없습니다. (public/data/zone-nova/characters/${c.id}.json)</div>`;
        return;
      }

      // 흔한 키 우선 렌더링
      const stats = d.combat_stats || d.stats || d.combatStats || null;
      const tags = d.tags || d.character_tags || d.characterTags || null;
      const skills = d.skills || d.skill || d.abilities || null;

      let body = header;

      if (stats && typeof stats === "object") {
        body += `<h3 class="detail-h3">Stats</h3>${kvTable(stats)}`;
      }

      if (Array.isArray(tags)) {
        const chips = tags.map(t => `<span class="chip">${String(t)}</span>`).join("");
        body += `<h3 class="detail-h3">Tags</h3><div class="chips">${chips}</div>`;
      }

      if (Array.isArray(skills)) {
        const list = skills.map(s => `<li>${(typeof s === "object") ? JSON.stringify(s) : String(s)}</li>`).join("");
        body += `<h3 class="detail-h3">Skills</h3><ul class="detail-ul">${list}</ul>`;
      }

      // 나머지는 raw JSON 제공(접기)
      body += `
        <h3 class="detail-h3">Raw</h3>
        <details class="raw">
          <summary>JSON 보기</summary>
          <pre>${escapeHtml(JSON.stringify(d, null, 2))}</pre>
        </details>
      `;

      modalBody.innerHTML = body;
    }

    function escapeHtml(str) {
      return (str || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    async function fetchAndOpen(cid) {
      openModal();
      modalBody.innerHTML = `<div class="modal-loading">Loading…</div>`;
      try {
        const r = await fetch(`/zones/zone-nova/characters/${encodeURIComponent(cid)}`, { cache: "no-store" });
        const j = await r.json();
        if (!j.ok) {
          modalBody.innerHTML = `<div class="detail-empty">불러오기 실패: ${escapeHtml(j.error || "unknown")}</div>`;
          return;
        }
        renderDetail(j);
      } catch (e) {
        modalBody.innerHTML = `<div class="detail-empty">불러오기 실패: ${escapeHtml(String(e))}</div>`;
      }
    }

    // 클릭 이벤트: 체크박스 클릭은 제외하고, 캐릭터 셀 클릭만 상세 오픈
    document.addEventListener("click", (e) => {
      const chk = e.target.closest(".chk-owned");
      if (chk) return;

      const cell = e.target.closest(".char-cell.clickable");
      if (!cell) return;

      const cid = cell.dataset.cid;
      if (cid) fetchAndOpen(cid);
    });

    render();
  </script>
</body>
</html>

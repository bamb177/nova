<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ title }}</title>

  <!-- 공통 스타일이 있으면 유지 -->
  <link rel="stylesheet" href="/css/select.css?v={{ last_refresh }}" />
  <link rel="stylesheet" href="/css/runes.css?v={{ last_refresh }}" />
</head>

<body>
  <div class="topbar">
    <div class="title">
      <div class="title-row">
        <h1>{{ title }}</h1>
        <div class="refresh">갱신 {{ last_refresh }}</div>
      </div>
      <div class="meta">Rune Sets / Main Stats / Sub Stats</div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="runes-head">
        <h2>룬 세트</h2>

        <div class="runes-controls">
          <input id="q" class="input" placeholder="룬 이름 검색 (예: Alpha, Giants)" />
          <select id="filter" class="select">
            <option value="all">전체</option>
            <option value="guild">길드 레이드 전용</option>
            <option value="restricted">클래스 제한 있음</option>
          </select>
        </div>
      </div>

      <div id="runeGrid" class="rune-grid"></div>
    </div>

    <div class="panel">
      <h2>위치별 메인 스탯</h2>
      <div id="mainStats" class="mainstats"></div>
    </div>

    <div class="panel">
      <h2>서브 스탯 가능 목록</h2>
      <div class="substats-note">
        모든 룬은 아래 서브 스탯 중 조합으로 등장할 수 있습니다. (희귀도/강화에 따라 개수·수치 상이)
      </div>

      <div class="substats-table">
        <div class="row head">
          <div>스탯 타입</div>
          <div>가능 형태</div>
        </div>
        <div class="row"><div>공격력</div><div>고정 수치, %</div></div>
        <div class="row"><div>HP</div><div>고정 수치, %</div></div>
        <div class="row"><div>방어력</div><div>고정 수치, %</div></div>
        <div class="row"><div>치명타 확률</div><div>%만</div></div>
        <div class="row"><div>치명타 피해</div><div>%만</div></div>
        <div class="row"><div>관통</div><div>고정 수치만</div></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { RUNE_SETS, MAIN_STATS_BY_POSITION } from "/data/zone-nova/runes.js";

    const runeGrid = document.getElementById("runeGrid");
    const q = document.getElementById("q");
    const filter = document.getElementById("filter");
    const mainStats = document.getElementById("mainStats");

    function isGuildOnly(r) {
      const note = (r.note || "").toLowerCase();
      return note.includes("길드") || note.includes("guild");
    }
    function isRestricted(r) {
      return !!r.classRestriction;
    }

    function runeCard(key, r) {
      const badges = [];
      if (isGuildOnly(r)) badges.push(`<span class="badge">길드 레이드</span>`);
      if (r.classRestriction) badges.push(`<span class="badge">클래스 제한</span>`);

      const two = r.twoPiece ? `<div class="line"><span class="tag">2세트</span><span>${escapeHtml(r.twoPiece)}</span></div>` : "";
      const four = r.fourPiece ? `<div class="line"><span class="tag">4세트</span><span>${escapeHtml(r.fourPiece)}</span></div>` : "";
      const note = r.note ? `<div class="note">※ ${escapeHtml(r.note)}</div>` : "";
      const restriction = r.classRestriction ? `<div class="note">적용 제한: ${escapeHtml(r.classRestriction)}</div>` : "";

      return `
        <article class="rune-card" data-key="${escapeHtml(key)}">
          <div class="thumb">
            <img loading="lazy" src="/images/games/zone-nova/runes/${encodeURIComponent(r.image)}" alt="${escapeHtml(r.name)}" />
          </div>
          <div class="body">
            <div class="top">
              <h3 class="name">${escapeHtml(r.name)}</h3>
              <div class="badges">${badges.join("")}</div>
            </div>
            <div class="effects">
              ${two}
              ${four}
            </div>
            ${restriction}
            ${note}
          </div>
        </article>
      `;
    }

    function renderRunes() {
      const keyword = (q.value || "").trim().toLowerCase();
      const f = filter.value;

      const entries = Object.entries(RUNE_SETS);
      const filtered = entries.filter(([key, r]) => {
        const hay = `${key} ${r.name}`.toLowerCase();
        if (keyword && !hay.includes(keyword)) return false;

        if (f === "guild" && !isGuildOnly(r)) return false;
        if (f === "restricted" && !isRestricted(r)) return false;

        return true;
      });

      runeGrid.innerHTML = filtered.map(([key, r]) => runeCard(key, r)).join("");

      if (!filtered.length) {
        runeGrid.innerHTML = `<div class="empty">검색 결과가 없습니다.</div>`;
      }
    }

    function renderMainStats() {
      const items = Object.entries(MAIN_STATS_BY_POSITION)
        .sort((a, b) => Number(a[0]) - Number(b[0]))
        .map(([pos, v]) => {
          const list = v.availableStats
            ? `<ul>${v.availableStats.map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>`
            : "";

          return `
            <div class="ms-card">
              <div class="ms-title">${escapeHtml(v.name || `Position ${pos}`)}</div>
              ${v.stat ? `<div class="ms-stat">${escapeHtml(v.stat)}</div>` : ""}
              ${v.description ? `<div class="ms-desc">${escapeHtml(v.description)}</div>` : ""}
              ${list}
            </div>
          `;
        })
        .join("");

      mainStats.innerHTML = `<div class="ms-grid">${items}</div>`;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    q.addEventListener("input", renderRunes);
    filter.addEventListener("change", renderRunes);

    renderRunes();
    renderMainStats();
  </script>
</body>
</html>
